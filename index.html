<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="ja">
<head>
<meta charset="utf-8">
<meta name="description" content="blog by Hiromasa OHASHI">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>hiromasa.info</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS (ja)" hreflang="ja" href="rss.xml">
<link rel="alternate" type="application/rss+xml" title="RSS (en)" hreflang="en" href="en/rss.xml">
<link rel="canonical" href="http://www.hiromasa.info/">
<link rel="next" href="index-8.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: http://*.google-analytics.com https://*.hiromasa.info https://*.google-analytics.com https://code.jquery.com http://*.disqus.com https://disqus.com https://*.disqus.com https://*.disquscdn.com https://*.cloudinary.com http://www.gravatar.com https://www.googletagmanager.com https://*.twitter.com http://*.facebook.com https://*.facebook.com https://*.facebook.net http://*.hatena.ne.jp https://*.st-hatena.com https://cdnjs.cloudflare.com https://fonts.gstatic.com;">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-48887105-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-48887105-1');
</script><!-- End Google Analytics --><!-- for facebook button --><style>
.fb-like {
    display: inline;
}
#fb-root {
    display: inline;
}
.fb_iframe_widget > span {
    vertical-align: baseline !important; 
}
</style>
<link rel="prefetch" href="posts/26/" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">本文を読み飛ばす</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href=".">

            <span id="blog-title">hiromasa.info</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav">
<li class="nav-item"><a href="en/" rel="alternate" hreflang="en" class="nav-link">English</a></li>

                    
                    
                    
            </ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="archive.html" class="nav-link">文書一覧</a>
                </li>
<li class="nav-item">
<a href="categories/" class="nav-link">タグ</a>
                </li>
<li class="nav-item">
<a href="pages/about/index.html" class="nav-link">about</a>
                </li>
<li class="nav-item">
<a href="pages/slides/index.html" class="nav-link">slide一覧</a>
                </li>
<li class="nav-item">
<a href="jupyterlite/lab/" class="nav-link">my jupyterlite</a>
                </li>
<li class="nav-item">
<a href="rss.xml" class="nav-link">RSSフィード</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
    
        

    
        
    <div class="postindex">
            <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/26/" class="u-url">2022/10/22 PyData Osaka #026における JupyterLite関連の紹介記事</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Hiromasa OHASHI
                    </span></p>
            <p class="dateline">
            <a href="posts/26/" rel="bookmark">
            <time class="published dt-published" datetime="2022-10-22T00:00:00+09:00" itemprop="datePublished" title="2022-10-22 00:00">2022-10-22 00:00</time></a>
            </p>
                        <p class="commentline">
    
    <a href="posts/26/#disqus_thread" data-disqus-identifier="cache/posts/26.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <h2>2022/10/22 PyData Osaka Meetup #026におけるJupyterLite関連の紹介記事</h2>
<p>本記事はタイトルの通り<a href="https://pydataosaka.connpass.com/event/261492/">PyData Osaka Meetup #026</a>で使用する、主にJupyterLiteについて紹介するための記事となります。</p>
<h3>Jupyterliteに関する翻訳記事の紹介(前半)</h3>
<p><a href="https://github.com/PyDataOsaka/jupyterblog-translation">このリポジトリ</a>で翻訳した内容を<a href="https://medium.com/pydata-osaka">Medium</a>へと転記しています。
StarやMediumでのフォローをよろしくお願いします。
本日のイベントでは下記ブログ記事を読んでいきます。</p>
<ul>
<li><a href="https://github.com/PyDataOsaka/jupyterblog-translation/blob/main/posts/2021-07-13-jupyterlite-loves-webassembly.md">jupyterlite loves webassembly</a></li>
<li><a href="https://github.com/PyDataOsaka/jupyterblog-translation/blob/main/posts/2022-07-14-mamba_meets_jupyterlite.md">mamba meets jupyterlite</a></li>
</ul>
<p>また、翻訳が間に合っておりませんが、下記2つの記事についても触れる予定です。</p>
<ul>
<li>
<a href="https://blog.jupyter.org/jupyter-everywhere-f8151c2cc6e8">Jupyter Everywhere</a><ul>
<li>ウェブページにコンソールやnotebookを埋め込む方法について書かれています</li>
</ul>
</li>
<li>
<a href="https://blog.jupyter.org/xeus-lite-379e96bb199d">Xeus lite</a><ul>
<li>カーネルを作成するためのC++ライブラリであるXeusをJupyterliteで使うための話が載っています。</li>
</ul>
</li>
</ul>
<p>上記についても将来的に翻訳したいと考えているため、回を分けて紹介するかもしれません。</p>
<h3>nikolaブログの記事をコンテンツとして追加した状態でjupyterlite静的サイトを作る方法(後半)</h3>
<p>本ブログはmarkdownとipynbで書かれていますが、これらの記事を追加した状態でjupyterliteの静的サイトをGitHub actionsで生成し、公開する例を紹介します。</p>
<h4>仕組みの概要</h4>
<ul>
<li>
<a href="https://github.com/wrist/wrist.github.io/tree/src">ブログのsrcブランチ</a>の内容を元に静的ブログをビルド(static site generatorのnikolaを使用)</li>
<li>
<a href="https://github.com/wrist/wrist.github.io/blob/src/.github/workflows/build.yml">このワークフロー</a>でブログ構築およびjupyterlite生成を自動化<ul>
<li>
<a href="https://github.com/wrist/docker-jupyterlab-custom">このリポジトリに従って作成されたDockerイメージ</a>を用いてワークフローを実行</li>
<li>jupyterliteを静的アセットとして動的に生成した上で、nikolaブログのビルドを行い、デプロイを実行</li>
<li>jupyterliteの生成のためには<a href="https://github.com/wrist/wrist.github.io/blob/src/generate_jupyterlite.sh">このスクリプト</a>を実行<ul>
<li>
<code>jupyter lite</code>コマンドのオプションは<a href="https://jupyterlite.readthedocs.io/en/latest/reference/cli.html">ここ</a>を参照</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>jupyterlab-wav</h4>
<p><a href="https://github.com/wrist/jupyterlab-wav">このリポジトリ</a>で公開しているjupyterlab向けの波形可視化エクステンションがありますが、
dockerでの実行環境内に存在している場合(actionsのworkflow内でpip installしている場合)は、federated extensionとして使用可能な状態になっているはずですので紹介します。</p>
<h4>GitHub Actions設定時に遭遇したトラブルと対策</h4>
<h5>
<code>actions/checkout@v3</code>で<code>EACCESS: permission denied</code>などとエラーが出てチェックアウトできない</h5>
<p><a href="https://github.com/actions/checkout/issues/841">ここ</a>を見て解決しましたが、コンテナ内でチェックアウトする場合は所有権の問題でチェックアウトできないようで、下記のように<code>options: --user root</code>を付けてroot実行が必要でした。</p>
<div class="code"><pre class="code literal-block"><span class="nt">container</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;image&gt;</span><span class="w"></span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">options</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--user root</span><span class="w"></span>
</pre></div>

<h5>
<code>fatal: unsafe repository</code>が出る</h5>
<p><a href="https://zenn.dev/kouta/scraps/726bfce243f72b">ここ</a>を参考に、<code>git config --global --add safe.directory</code>を実行するようにした。</p>
<h5>
<code>fatal: refusing to merge unrelated histories</code>と表示され落ちる</h5>
<p>masterブランチがfetchされておらずローカルとリモートが連続していないことが原因でした。
<code>git fetch origin master --depth 1</code>を追加することで解決しました。</p>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/25/" class="u-url">jupyterlab-wav extensionをjupyterlab 3.xへ対応させた上でWaveSurfer.jsで波形・スペクトログラムが描画できるようにした</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Hiromasa OHASHI
                    </span></p>
            <p class="dateline">
            <a href="posts/25/" rel="bookmark">
            <time class="published dt-published" datetime="2021-06-18T00:00:00+09:00" itemprop="datePublished" title="2021-06-18 00:00">2021-06-18 00:00</time></a>
            </p>
                        <p class="commentline">
    
    <a href="posts/25/#disqus_thread" data-disqus-identifier="cache/posts/25.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <p>この記事では以前に<a href="https://www.hiromasa.info/posts/20/">このポスト</a>で作成した<code>jupyterlab-wav</code>のExtensionを
<a href="https://wavesurfer-js.org/">WaveSurfer.js</a>を用いて波形+スペクトログラムが描画できるように今年の2月ごろに改良したのでその過程について説明します。
(この文章自体3月に書いたまま放置していたため内容として古くなっている部分があるかもしれません)。</p>
<h3>jupyterlab 3.x系への対応</h3>
<p><a href="https://blog.jupyter.org/jupyterlab-3-0-is-out-4f58385e25bb">Jupyter blog</a>でも紹介されているようにJupyterlab 3.0が2021年の年始にリリースされました。
jupyterlab 3.x系では<a href="https://www.hiromasa.info/posts/21/">このポスト</a>でも触れたDebuggerが導入されたなどの話もありますが、
extension開発者にとって大きな変更点として<code>JupyterLab extensions can now be distributed as prebuilt extensions, which do not require a user to rebuild JupyterLab or have Node.js installed.</code>
とあるように、prebuilt extensionをPyPIなどに登録することによってpipやcondaでextensionをインストールできるようになったことが挙げられます。
これにより、npmやjupyterによるローカルでのビルドなどが不要となったためユーザーはより気軽にExtensionを導入できるようになりました (後述のように従来通りnpmjsからインストールすることも可能です)。</p>
<p>そんな訳で<code>jupyterlab-wav</code>もpipでインストールできるようになりました。</p>
<div class="code"><pre class="code literal-block">$ pip install jupyterlab-wav
</pre></div>

<p>で簡単に導入できます。</p>
<h3>
<a href="https://wavesurfer-js.org/">WaveSurfer.js</a>の導入</h3>
<p>以前のポストで作成した<code>jupyterlab-wav</code>はMIME Rendererのテンプレートをそのまま使っただけのものでしたが、
今回の更新にあたり<a href="https://wavesurfer-js.org/">WaveSurfer.js</a>を用いて波形・スペクトログラムが描画できるようになりました。
また、wavファイルだけでなくmp3ファイルとflacファイルも再生できるようになりました。</p>
<p><img alt="screenshot" src="images/25/screenshot_v020.png"></p>
<p>マルチチャンネルファイルのスペクトログラムが描画できないなど、まだまだ不具合などは残っていますが最低限使えるような状態にはなっています。</p>
<h3>jupyterlab extensionの2.x系から3.x系への更新作業</h3>
<p>2.x系から3.x系へとextensionを更新する際には
<a href="https://jupyterlab.readthedocs.io/en/latest/extension/extension_migration.html">Extension Migration Guide</a>を見ながら作業を行いました。</p>
<h4>手動で<code>package.json</code>のバージョンを上げる場合</h4>
<p>下記の<code>@jupyterlab/application</code>のバージョンを^3.0.0へと変更すれば良いとのこと。</p>
<div class="code"><pre class="code literal-block"><span class="w">  </span><span class="nt">"dependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nt">"@jupyterlab/application"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^3.0.0"</span><span class="p">,</span><span class="w"></span>
</pre></div>

<p>しかしjupyterlab 3.0には前述のようにextensionを<code>PyPI</code>や<code>conda-forge</code>にアップロードすることで<code>pip</code>や<code>conda</code>でextensionがインストールできるようになり、
そのためのパッケージングの仕組みが提供されているため、下記手順に沿って対応した方が良いと思われます。</p>
<h4>upgradeスクリプトを用いた更新</h4>
<p>Jupyterlab 3.0はupgrade用のスクリプトを公開しているのでこれを用いてバージョンを上げたいと思います。
まずpipで<code>jupyter-packaging</code>と<code>cookiecutter</code>をインストールします。</p>
<div class="code"><pre class="code literal-block">$ pip install jupyterlab -U
$ pip install jupyter-packaging cookiecutter
</pre></div>

<p>上記を実行した上でextensionのルートディレクトリで下記コマンドを実行すると対話的に各種項目を設定することができます。
<code>python_name [wrist_jupyterlab_wav]:</code>の部分はpythonパッケージ名となり、ここではデフォルトのまま実行していましたが、最終的には各種設定を手動で<code>jupyterlab_wav</code>に書き直しています。</p>
<div class="code"><pre class="code literal-block">$ python -m jupyterlab.upgrade_extension .
author_name <span class="o">[</span>wrist &lt;stoicheia1986@gmail.com&gt;<span class="o">]</span>:
python_name <span class="o">[</span>wrist_jupyterlab_wav<span class="o">]</span>:
labextension_name <span class="o">[</span>@wrist/jupyterlab-wav<span class="o">]</span>:
project_short_description <span class="o">[</span>A JupyterLab extension <span class="k">for</span> rendering wav files.<span class="o">]</span>:
has_server_extension <span class="o">[</span>n<span class="o">]</span>:
has_binder <span class="o">[</span>n<span class="o">]</span>:
repository <span class="o">[</span>https://github.com/wrist/jupyterlab-wav<span class="o">]</span>:
overwrite scripts <span class="k">in</span> package.json? <span class="o">[</span>n<span class="o">]</span>:
overwrite <span class="s2">".gitignore"</span>? <span class="o">[</span>n<span class="o">]</span>:
overwrite <span class="s2">"README.md"</span>? <span class="o">[</span>n<span class="o">]</span>:
overwrite <span class="s2">"tsconfig.json"</span>? <span class="o">[</span>n<span class="o">]</span>:
overwrite <span class="s2">"src/index.ts"</span>? <span class="o">[</span>n<span class="o">]</span>:
overwrite <span class="s2">"style/index.css"</span>? <span class="o">[</span>n<span class="o">]</span>:
** package.json scripts must be updated manually
** skipped _temp_extension/.gitignore
** skipped _temp_extension/README.md
** skipped _temp_extension/tsconfig.json
** skipped _temp_extension/src/index.ts
** skipped _temp_extension/style/index.css
** Remove _temp_extensions directory when finished
<span class="o">(</span>
</pre></div>

<p>上記を実行すると、<code>package.json</code>が下記のように上書きされます。</p>
<div class="code"><pre class="code literal-block"><span class="w">(base) jovyan@188a4999b58c:/mnt/work/python/tmp/jupyterlab-wav$ git diff</span>
<span class="gh">diff --git a/package.json b/package.json</span><span class="w"></span>
<span class="gh">index 0feeaed..cf1620b 100644</span><span class="w"></span>
<span class="gd">--- a/package.json</span><span class="w"></span>
<span class="gi">+++ b/package.json</span><span class="w"></span>
<span class="gu">@@ -4,8 +4,11 @@</span><span class="w"></span>
<span class="w"> </span>  "description": "A JupyterLab extension for rendering wav files.",<span class="w"></span>
<span class="w"> </span>  "author": "wrist &lt;stoicheia1986@gmail.com&gt;",<span class="w"></span>
<span class="w"> </span>  "homepage": "https://github.com/wrist/jupyterlab-wav",<span class="w"></span>
<span class="gd">-  "repository": {"type": "git", "url": "https://github.com/wrist/jupyterlab-wav"},</span><span class="w"></span>
<span class="gd">-  "license" : "MIT",</span><span class="w"></span>
<span class="gi">+  "repository": {</span><span class="w"></span>
<span class="gi">+    "type": "git",</span><span class="w"></span>
<span class="gi">+    "url": "https://github.com/wrist/jupyterlab-wav"</span><span class="w"></span>
<span class="gi">+  },</span><span class="w"></span>
<span class="gi">+  "license": "MIT",</span><span class="w"></span>
<span class="w"> </span>  "main": "lib/index.js",<span class="w"></span>
<span class="w"> </span>  "types": "lib/index.d.ts",<span class="w"></span>
<span class="w"> </span>  "style": "style/index.css",<span class="w"></span>
<span class="gu">@@ -16,27 +19,38 @@</span><span class="w"></span>
<span class="w"> </span>  ],<span class="w"></span>
<span class="w"> </span>  "files": [<span class="w"></span>
<span class="w"> </span>    "lib/**/*.{d.ts,eot,gif,html,jpg,js,js.map,json,png,svg,woff2,ttf}",<span class="w"></span>
<span class="gd">-    "style/**/*.{css,eot,gif,html,jpg,json,png,svg,woff2,ttf}"</span><span class="w"></span>
<span class="gi">+    "style/**/*.{css,eot,gif,html,jpg,json,png,svg,woff2,ttf}",</span><span class="w"></span>
<span class="gi">+    "style/index.js"</span><span class="w"></span>
<span class="w"> </span>  ],<span class="w"></span>
<span class="w"> </span>  "jupyterlab": {<span class="w"></span>
<span class="gd">-    "mimeExtension": true</span><span class="w"></span>
<span class="gi">+    "mimeExtension": true,</span><span class="w"></span>
<span class="gi">+    "outputDir": "wrist_jupyterlab_wav/labextension"</span><span class="w"></span>
<span class="w"> </span>  },<span class="w"></span>
<span class="w"> </span>  "scripts": {<span class="w"></span>
<span class="gd">-    "clean": "rimraf lib &amp;&amp; rimraf tsconfig.tsbuildinfo",</span><span class="w"></span>
<span class="w"> </span>    "build": "tsc",<span class="w"></span>
<span class="gd">-    "prepare": "npm run clean &amp;&amp; npm run build",</span><span class="w"></span>
<span class="gd">-    "watch": "tsc -w",</span><span class="w"></span>
<span class="gi">+    "clean": "rimraf lib &amp;&amp; rimraf tsconfig.tsbuildinfo",</span><span class="w"></span>
<span class="gi">+    "extension:disable": "jupyter labextension disable jupyterlab-wav",</span><span class="w"></span>
<span class="gi">+    "extension:enable": "jupyter labextension enable jupyterlab-wav",</span><span class="w"></span>
<span class="w"> </span>    "extension:install": "jupyter labextension install jupyterlab-wav",<span class="w"></span>
<span class="w"> </span>    "extension:uninstall": "jupyter labextension uninstall  jupyterlab-wav",<span class="w"></span>
<span class="gd">-    "extension:enable": "jupyter labextension enable jupyterlab-wav",</span><span class="w"></span>
<span class="gd">-    "extension:disable": "jupyter labextension disable jupyterlab-wav"</span><span class="w"></span>
<span class="gi">+    "prepare": "npm run clean &amp;&amp; npm run build",</span><span class="w"></span>
<span class="gi">+    "watch": "tsc -w"</span><span class="w"></span>
<span class="w"> </span>  },<span class="w"></span>
<span class="w"> </span>  "dependencies": {<span class="w"></span>
<span class="gd">-    "@jupyterlab/rendermime-interfaces": "^2.0.0",</span><span class="w"></span>
<span class="gd">-    "@lumino/widgets": "^1.5.0"</span><span class="w"></span>
<span class="gi">+    "@jupyterlab/rendermime-interfaces": "^3.0.2",</span><span class="w"></span>
<span class="gi">+    "@lumino/widgets": "^1.16.1"</span><span class="w"></span>
<span class="w"> </span>  },<span class="w"></span>
<span class="w"> </span>  "devDependencies": {<span class="w"></span>
<span class="gd">-    "rimraf": "^2.6.3",</span><span class="w"></span>
<span class="gd">-    "typescript": "~3.7.0"</span><span class="w"></span>
<span class="gd">-  }</span><span class="w"></span>
<span class="gd">-}</span><span class="w"></span>
<span class="gi">+    "@jupyterlab/builder": "^3.0.0",</span><span class="w"></span>
<span class="gi">+    "@typescript-eslint/eslint-plugin": "^4.8.1",</span><span class="w"></span>
<span class="gi">+    "@typescript-eslint/parser": "^4.8.1",</span><span class="w"></span>
<span class="gi">+    "eslint": "^7.14.0",</span><span class="w"></span>
<span class="gi">+    "eslint-config-prettier": "^6.15.0",</span><span class="w"></span>
<span class="gi">+    "eslint-plugin-prettier": "^3.1.4",</span><span class="w"></span>
<span class="gi">+    "npm-run-all": "^4.1.5",</span><span class="w"></span>
<span class="gi">+    "prettier": "^2.1.1",</span><span class="w"></span>
<span class="gi">+    "rimraf": "^3.0.2",</span><span class="w"></span>
<span class="gi">+    "typescript": "~4.1.3"</span><span class="w"></span>
<span class="gi">+  },</span><span class="w"></span>
<span class="gi">+  "styleModule": "style/index.js"</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
</pre></div>

<p>各種依存ライブラリのバージョンが更新されていることが分かります。
<code>@jupyterlab/builder</code>が<code>devDependency</code>に追加されているが、これは<code>federated extension</code>としてextensionをビルドするために必要となるものです。
これはwebpackのような依存を内部に隠蔽し、pythonパッケージの一部として配布可能なassetを生成するものとのことです。
extension開発においては直接<code>@jupyterlab/builder</code>を対話的に操作することはないが、その代わりに<code>jupyter labextension build</code>コマンドを用いることができます。
このコマンドはビルドスクリプト<code>jlpm run build</code>の一部として自動的に実行されます。</p>
<p>また、<code>python -m jupyterlab.upgrade_extension .</code>の実行によりパッケージングに必要となる<code>setup.py</code>や<code>pyproject.toml</code>などが生成されています。
実際に実行したところ、下記のファイル/ディレクトリ群が追加されていました。</p>
<div class="code"><pre class="code literal-block">.eslintignore
.eslintrc.js
.github/
.prettierignore
.prettierrc
LICENSE
MANIFEST.in
_temp_extension/
install.json
pyproject.toml
setup.py
style/base.css
style/index.js
wrist_jupyterlab_wav/
</pre></div>

<p><code>eslint</code>は構文チェック、<code>prettier</code>はフォーマッタであり、それらの設定ファイルが追加されています。
<code>LICENSE</code>は自動的に追加されていたが中身は3条項BSDライセンスでした。元々存在していたpackage.jsonにはLicenseをMITと記載していましたが、これを受けてBSD3-clauseに修正しています。</p>
<p><code>.github</code>以下にはgithub actionsで使用するworkflow定義のymlファイルが格納されています。<code>main</code>ブランチに対して動作するため、今回はmasterに対して発動するように修正しています。</p>
<p>また、実際にgithubにpushしてactionsのタブを見るとbuild時にエラーが出ていました、これは<code>package.json</code>の<code>scripts</code>に<code>eslint:check</code>が存在していないためでした。
ここでは下記のscirptsを追加した上で、実際にeslintを実行して指摘箇所の修正を行いました。</p>
<div class="code"><pre class="code literal-block"><span class="w">   </span><span class="nt">"eslint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eslint . --ext .ts,.tsx --fix"</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="nt">"eslint:check"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eslint . --ext .ts,.tsx"</span><span class="p">,</span><span class="w"></span>
</pre></div>

<p>ここに限らずmigrateの過程でpackage.jsonにscriptが全て追加されておらず、<code>build:prod</code>のscriptがないために生じたエラーなどにも遭遇しましたが、
最終的には<code>https://github.com/jupyterlab/extension-cookiecutter-ts</code>のリポジトリのpackage.jsonに記載のscriptを追加することで解決しています。</p>
<h4>extensionのローカルインストール</h4>
<p><a href="https://www.hiromasa.info/posts/20/">過去に書いた記事</a>では下記のようにビルドを実行していましたが、</p>
<div class="code"><pre class="code literal-block">$ jlpm install
$ jlpm run build
$ jupyter labextension install . --no-build
$ jupyter lab
</pre></div>

<p>テンプレートディレクトリのREADME.mdに記載されている下記手順のように実行することでローカルでのテスト用にextensionをjupyterlabにリンクできます。</p>
<div class="code"><pre class="code literal-block">$ pip install -e .
$ jupyter labextension develop . --overwrite
$ jlpm run build
</pre></div>

<p>jlpmによるビルドが終了した後にjupyterlabを立ち上げるとextensionが有効化されているはずです。</p>
<h3>jupyterlab-wavの修正</h3>
<p>今回の作業のついでに<code>jupyterlab-wav</code>を改良しています。
前述のように波形可視化ライブラリである<code>wavesurfer.js</code>を追加し、これを用いて描画を試みていますが、
下記のように最初にjlpmでパッケージをいくつか追加しています。</p>
<div class="code"><pre class="code literal-block">$ jlpm add wavesurfer.js
$ jlpm add @types/wavesurfer.js
$ jlpm add colormap
</pre></div>

<h3>react-widgetの導入</h3>
<p>以前のMIME Extensionのテンプレートを改造しただけのプロジェクトでは<code>IRenderMime.IRenderer</code>を実装するためのクラスを作り、
ファイルをjupyterlabで開いた際に呼ばれる<code>renderModel</code>メソッドを定義して<code>audio</code>要素に<code>src</code>属性を設定していただけでしたが、
今回の修正では<code>react-widget</code>を下記コードのように導入しています。</p>
<div class="code"><pre class="code literal-block"><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ReactWidget</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@jupyterlab/apputils'</span><span class="p">;</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">IRenderMime</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@jupyterlab/rendermime-interfaces'</span><span class="p">;</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'react'</span><span class="p">;</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">AudioComponent</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./AudioComponent'</span><span class="p">;</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">CLASS_NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'mimerenderer-wav'</span><span class="p">;</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * A widget for rendering wav.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">WavWidget</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">ReactWidget</span><span class="w"> </span><span class="k">implements</span><span class="w"> </span><span class="nx">IRenderMime</span><span class="p">.</span><span class="nx">IRenderer</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">IRenderMime.IRendererOptions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">_mimeType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">mimeType</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">_src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">CLASS_NAME</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">renderModel</span><span class="p">(</span><span class="nx">model</span><span class="o">:</span><span class="w"> </span><span class="kt">IRenderMime.IMimeModel</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_mimeType</span><span class="p">]</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">_src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`data:</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">_mimeType</span><span class="si">}</span><span class="sb">;base64,</span><span class="si">${</span><span class="nx">data</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">render</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">AudioComponent</span><span class="w"> </span><span class="nx">src</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">_src</span><span class="p">}</span><span class="w"> </span><span class="o">/&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">_src</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">_mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

<p>jupyterlab上でファイルを開いた際に<code>renderModel</code>メソッドが呼ばれる点は同じですが、
この際に<code>this.update()</code>を実行することで<code>ReactWidget</code>をextendsする際に必須となる<code>render</code>メソッドを明示的に呼び出しています。
<code>render</code>メソッドは<code>&lt;AudioComponent ...&gt;</code>のJSXタグを返しますが、この<code>AudioComponent</code>は<code>AudioComponent.tsx</code>内で定義されたReactコンポーネントとなります。
Reactコンポーネント自体はjupyterlabと独立にReact単体のエコシステム上で別途動作検証やデバッグができるため、
<code>ReactWidget</code>の導入によりextension開発が容易になりました。</p>
<h3>extensionの公開方法</h3>
<p>パッケージングの方法については<a href="https://jupyterlab.readthedocs.io/en/latest/extension/extension_tutorial.html#packaging-your-extension">extension tutorialのpackagingの部分</a>に、
アップロードの方法については<a href="https://jupyterlab.readthedocs.io/en/latest/extension/extension_tutorial.html#extension-tutorial-publish">extension tutorialのpublishに関する部分</a>に説明があります。</p>
<h4>PyPIへのアップロード</h4>
<p>自動生成された<code>setup.py</code>を用いてパッケージのビルドを行います。</p>
<div class="code"><pre class="code literal-block">$ python setup.py build sdist
$ python setup.py build bdist_wheel
</pre></div>

<p>ビルドの成果物がdist以下に保存されるので、これらをPyPIへとアップロードします。
ここではtwineを使ってアップロードを行います。
予めTestPyPIにアップロードし問題ないことを確認した上でPyPIへとアップロードします。</p>
<div class="code"><pre class="code literal-block">$ pip install twine
$ twine upload --repository-url https://test.pypi.org/legacy/ dist/*
$ twine upload dist/*
</pre></div>

<h4>npmjsへのアップロード</h4>
<p>extensionはPyPIやconda-forgeにアップロードするだけでなく、従来のようにnpmへとアップロードすることもできます。
これはnpmパッケージとして配布することでユーザーがJupyterLab 1.xや2.xと同様にextensionを明示的にコンパイルして追加することが可能となるためであったり、
他のextensionからサービスとして利用されるextensionを公開したい場合はJavaScriptパッケージをpublishする必要があるためとのことです。</p>
<p>以前の記事では<code>npm</code>を使ってアップロードしていましたが、ここではjlpmを使ってアップロードを試みました。</p>
<div class="code"><pre class="code literal-block">$ jlpm publish --access<span class="o">=</span>public
</pre></div>

<h4>作成中に遭遇した問題</h4>
<ul>
<li>複数の音源ファイルを開いた場合に一つのタブに描画されてしまう<ul>
<li>描画対象のdivをidで指定していたためであり、Reactの<code>useRef</code>を用いた参照に切り替えることによって解決</li>
</ul>
</li>
<li>開発用の手順が失敗する<ul>
<li>
<code>jupyter labextension develop . --overwrite</code>に失敗したが、これはPyPIに公開するパッケージディレクトリ(<code>jupyterlab_wav</code>)の下に<code>__init__.py</code>と<code>_version.py</code>がないためでした</li>
<li>
<a href="https://github.com/jupyterlab/extension-cookiecutter-ts/tree/3.0/%7B%7Bcookiecutter.python_name%7D%7D/%7B%7Bcookiecutter.python_name%7D%7D">このテンプレート</a>のファイルを加工して使うことで成功するようになりました</li>
</ul>
</li>
</ul>
<h4>既知の問題</h4>
<ul>
<li>Multi channelのaudioファイルが正しく描画されない<ul>
<li>波形は<code>splitChannels</code>オプションを使うことで分割して描画されるようになりました</li>
<li>スペクトログラムは要対応</li>
</ul>
</li>
<li>タブの再描画などの際に以前に再生した音声が止まらないまま残ってしまう<ul>
<li>再生中にタブを閉じると再生され続ける<ul>
<li>ReactWidgetの解放時に確実に止めるための何かが必要ではないかと思われる</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>今後改良したい点</h4>
<ul>
<li>FFT長選択のUIをつける</li>
<li>Jupyterlabから設定を行えるようにする</li>
<li>キーボードショートカットをつける(スペースで再生など)</li>
<li>timelineの単位の指定(サンプルなど)</li>
<li>colormapの制御</li>
</ul>
</div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/24/" class="u-url">Debian 10 busterを初代Mac mini (A1176; 2006)にインストール</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Hiromasa OHASHI
                    </span></p>
            <p class="dateline">
            <a href="posts/24/" rel="bookmark">
            <time class="published dt-published" datetime="2020-11-22T00:00:00+09:00" itemprop="datePublished" title="2020-11-22 00:00">2020-11-22 00:00</time></a>
            </p>
                        <p class="commentline">
    
    <a href="posts/24/#disqus_thread" data-disqus-identifier="cache/posts/24.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <h3>経緯</h3>
<p><a href="https://www.hiromasa.info/posts/23/">前回の記事</a>を書いた後にUbuntu 18.04がインストールされていたMacBook Pro 2009のトラックパッドがバッテリー膨張による圧力によって割れるという惨事が発生してしまった。
このMacBook Proは以前に一度ファンとバッテリーを自力で換装したことがあるものであり、もう限界と判断して押入れに眠っていたMac mini 2006(大学の先輩から2万円で譲ってもらったもの)を復活させることを決意したのであった。</p>
<p><img alt="白昼夢の惨劇" src="images/24/broken_mbp.jpg"></p>
<h4>ディストリビューションの選択</h4>
<p>当初はarch linuxを入れようかと思い、<code>x86_64</code>のISOイメージをUSBに焼いてインストールしようとしたが、このタイミングでこのマシンのCPUが<code>x86_64</code>ではなく<code>i686</code>、つまり32bit CPUであるということが発覚した。
2020年にもなり32bit CPUのマシンを稼働させることに躊躇いもあったが、調べたところUbuntuが32bit対応の廃止を表明している一方でDebianは32bit対応のイメージを今でも配布しているということもありインストールすることを決めた。</p>
<h4>マシンのスペック</h4>
<p><a href="https://www.apple.com/jp/support/datasheet/desktop/macmini_607_608.html">ここ</a>に載っている1.66GHzのCPUを積んでいるものである。</p>
<ul>
<li>CPU<ul>
<li>1.66GHz Core Duo</li>
</ul>
</li>
<li>メモリ<ul>
<li>2GB(DDR2; 667MHz)</li>
</ul>
</li>
<li>ディスク容量<ul>
<li>60GB</li>
</ul>
</li>
</ul>
<p>ちなみに<a href="http://www.nextro.com/directworld/cms/%E3%81%84%E3%81%BE%E3%81%95%E3%82%89%E5%88%9D%E4%BB%A3-intel-mac-mini-a1176-%EF%BC%882006%EF%BC%89%E3%83%95%E3%82%A1%E3%83%BC%E3%83%A0%E3%82%A6%E3%82%A7%E3%82%A2-1-1-%E3%81%8B%E3%82%89-2-1-%E3%81%AB/">この記事</a>によればファームウェアをアップデートした場合CPUの換装や4GBまでのメモリの増設が可能になるらしい。</p>
<h4>想定使用用途</h4>
<ul>
<li>ファイルサーバ<ul>
<li>外付けHDDにもともと保存していたデータに対してsambaでアクセスしたいため</li>
</ul>
</li>
<li>VPNサーバ<ul>
<li>移行元マシンで稼働していたSoftEtherの設定を引き継ぐ</li>
</ul>
</li>
</ul>
<hr>
<h3>実際の作業</h3>
<p>全般的に自分用のメモ書きである。</p>
<h4>DebianのISOをUSBに焼く</h4>
<p>ここでは<code>debian-10.6.0-i386-netinst.iso</code>を公式から落としてきてUSBメモリに書き込んだ。
この作業は今回使用するMac miniではない別のマシンで行っている。</p>
<div class="code"><pre class="code literal-block">$ df -hか何かでUSBメモリのデバイスのパスを確認する<span class="o">(</span>ここでは<span class="sb">`</span>/dev/disk4<span class="sb">`</span><span class="o">)</span>
$ diskutil umountDisk /dev/disk4
$ sudo dd <span class="k">if</span><span class="o">=</span>debian-10.6.0-i386-netinst.iso <span class="nv">of</span><span class="o">=</span>/dev/rdisk4  <span class="c1"># /dev/rdisk4, とrを付けると早く書き込まれるらしい</span>
</pre></div>

<hr>
<h4>Mac mini上での作業</h4>
<h5>rEFIndのインストール</h5>
<p>mac miniのosx側で予めrEFIndをインストールしておく。
rEFIndに同梱のインストールスクリプトを実行した上で再起動すると起動時にrEFIndが立ち上がるはずである。
ちなみにmac miniに入っていたosxのバージョンはLepardであった。</p>
<h5>mac mini側のディスクユーティリティでosxのパーティションサイズを縮小しておく</h5>
<p>HFS+フォーマットのosxがインストールされた領域のサイズを20GB程度に縮小した。
残りの領域についてはこの時点でフォーマットなどは実施しない(GUIインストーラの実行時にやってくれるため)。</p>
<h5>GUIインストーラによるDebianのインストール</h5>
<p>rEFIndが使えるようになるとUSBメモリに焼いたbootableイメージからインストーラを起動することが可能となる。
GUIインストーラで提示された項目を選んでいくだけで基本的には問題なくインストールは完了した。
パーティションは予めosx側で分割した残りの空き領域に対しインストーラが自動的にroot, var, tmp, swap, homeを分割してくれたのでその通りにした。LVMは使っていない。ファイルシステムはext4になっている。
デスクトップ環境はメモリが2GBしかなく必要かどうか悩んだがxfce4とした。
SSHサーバもインストーラの選択肢で選べたためインストールしておく。
よって基本的にこれ以降の作業はSSH越しの作業である。</p>
<hr>
<h4>ルーターの固定IP割当設定</h4>
<p>以降でローカルLAN内でIPアドレスを固定化するためにルーターの割当設定を行っておく。
Debian上で<code>ip addr</code>でMACアドレスを表示させ、有線LANのNICとWiFiアダプタに対して固定IP割当を設定。</p>
<hr>
<h4>Debian起動直後における設定</h4>
<h5>sudoグループへの所属</h5>
<p>インストール時に登録したユーザーがデフォルトではsudoを使えないため、一度suでrootユーザになった上でsudoグループに所属させる。
<code>$</code>は一般ユーザ、<code>#</code>はrootユーザでの実行を意味する。</p>
<div class="code"><pre class="code literal-block">$ su
<span class="c1"># gpasswd -a ${username} sudo</span>
<span class="c1"># exit</span>
</pre></div>

<h5>SSHの設定</h5>
<p>鍵認証による接続を行うために公開鍵の登録をした後に<code>/etc/ssh/sshd_config</code>を編集する。
公開鍵はクライアント側から<code>ssh-copy-id -i id_rsa.pub ${ipaddr}</code>で転送しても良いが、GitHubに登録してある公開鍵を使う場合は<code>wget https://github.com/${username}.keys -qO - &gt;&gt; ~/.ssh/authorized_keys</code>で<code>authorized_keys</code>に追記しても良い。</p>
<p>次に<code>sudo vi /etc/ssh/sshd_config</code>に下記項目を設定する。</p>
<div class="code"><pre class="code literal-block">Port ポート番号  # 変更したい場合
PubkeyAuthentication yes
PermitRootLogin no
PermitEmptyPasswords no
PasswordAuthentication no
</pre></div>

<p>設定後、<code>sudo systemctl restart sshd</code>でsshdを再起動する。</p>
<p>このタイミングで他のターミナルからsshしてパスワードログインができなくなっていることを確認する。
(元々接続していたターミナルでexitしてしまうと再度接続できなくなってしまったときに困る)。</p>
<p>その後に、クライアント側で<code>~/.ssh/config</code>を下記のように編集しておくと<code>ssh hostname</code>で接続できるようになるため便利である。</p>
<div class="code"><pre class="code literal-block">Host hostname
    HostName <span class="cp">${</span><span class="n">ipaddr</span><span class="cp">}</span>
    Port ポート番号
    preferredauthentications publickey
    IdentityFile "/path/to/id_rsa"
</pre></div>

<h5>ホームディレクトリ配下の日本語ディレクトリの英語化</h5>
<p>セットアップ時に日本語を選択するとホームディレクトリ配下の各種ディレクトリが日本語になってしまっている場合がある。
その場合は<code>LC_ALL=C xdg-user-dirs-gtk-update --force</code>を実行して英語ディレクトリを作成する。
日本語ディレクトリはそのまま残ってしまうため不要であれば消す。</p>
<h5>aptで色々入れる</h5>
<p>とりあえず最低限のパッケージと<a href="https://www.hiromasa.info/posts/23/">前回の記事</a>で書いたように最新版のsambaを使うためのppaを追加する。
最初にインストールする<code>software-properties-common</code>はdebianで<code>add-apt-repository</code>を使うために必要である。</p>
<div class="code"><pre class="code literal-block">$ sudo apt update
$ sudo apt upgrade
$ sudo apt install -y software-properties-common
$ sudo add-apt-repository ppa:linux-schools/samba-latest
$ sudo apt dist-upgrade
$ sudo apt install -y git vim zsh tmux curl htop
$ sudo apt install -y samba
$ sudo apt install -y build-essential autotools-dev libtool automake autoconf autogen
</pre></div>

<p>しかしリポジトリにppaを追加した後にupdateを掛けたところ無効である旨が表示されたためDebianでは使用不可能であった。</p>
<hr>
<h4>シェル環境周りの設定</h4>
<h5>tmuxの設定</h5>
<p><code>.tmux.conf</code>を作成し<code>C-t</code>をprefixキーとするために下記のような<code>.tmux.conf</code>を<code>~</code>以下に配置した。</p>
<div class="code"><pre class="code literal-block"><span class="nv">unbind</span><span class="w"> </span><span class="nv">C</span><span class="o">-</span><span class="nv">b</span><span class="w"></span>
<span class="nv">set</span><span class="o">-</span><span class="nv">option</span><span class="w"> </span><span class="o">-</span><span class="nv">g</span><span class="w"> </span><span class="nv">prefix</span><span class="w"> </span><span class="nv">C</span><span class="o">-</span><span class="nv">t</span><span class="w"></span>
<span class="nv">set</span><span class="o">-</span><span class="nv">window</span><span class="o">-</span><span class="nv">option</span><span class="w"> </span><span class="o">-</span><span class="nv">g</span><span class="w"> </span><span class="nv">mode</span><span class="o">-</span><span class="nv">keys</span><span class="w"> </span><span class="nv">vi</span><span class="w"></span>
<span class="nv">bind</span><span class="w"> </span><span class="nv">C</span><span class="o">-</span><span class="nv">t</span><span class="w"> </span><span class="k">send</span><span class="o">-</span><span class="nv">prefix</span><span class="w"></span>
</pre></div>

<h5>シェルをzshに変える</h5>
<div class="code"><pre class="code literal-block">$ chsh  <span class="c1"># /bin/zshを指定</span>
</pre></div>

<p>再ログインすると色々zshの設定に関する対話スクリプトが走るが、blankファイルだけ生成して脱出した。
その上で下記のような設定を<code>.zshrc</code>に記述した。
内容自体は他マシンにおける設定の使い回しであるため各自好きに変更すると良いと思う。</p>
<div class="code"><pre class="code literal-block"><span class="n">setopt</span><span class="w"> </span><span class="n">autopushd</span><span class="w"></span>
<span class="n">setopt</span><span class="w"> </span><span class="n">auto_cd</span><span class="w"></span>

<span class="n">WORDCHARS</span><span class="o">=</span><span class="s1">'*?_-.[]~=&amp;;!#$%^(){}&lt;&gt;'</span><span class="w"></span>

<span class="n">compctl</span><span class="w"> </span><span class="o">-</span><span class="n">M</span><span class="w"> </span><span class="s1">'m:{a-z}={A-Z}'</span><span class="w"></span>

<span class="n">setopt</span><span class="w"> </span><span class="n">IGNOREEOF</span><span class="w"></span>

<span class="n">umask</span><span class="w"> </span><span class="mi">002</span><span class="w"></span>

<span class="n">HISTFILE</span><span class="o">=$</span><span class="n">HOME</span><span class="o">/.</span><span class="n">zsh</span><span class="o">-</span><span class="n">history</span><span class="w"></span>
<span class="n">HISTSIZE</span><span class="o">=</span><span class="mi">10000</span><span class="w"></span>
<span class="n">SAVEHIST</span><span class="o">=</span><span class="mi">10000</span><span class="w"></span>

<span class="n">setopt</span><span class="w"> </span><span class="n">hist_ignore_dups</span><span class="w"> </span><span class="c1"># ignore duplication command history</span><span class="w"></span>
<span class="n">setopt</span><span class="w"> </span><span class="n">extended_history</span><span class="w"></span>
<span class="n">setopt</span><span class="w"> </span><span class="n">share_history</span><span class="w"></span>
<span class="n">function</span><span class="w"> </span><span class="n">history</span><span class="o">-</span><span class="n">all</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">history</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="c1"># bind</span><span class="w"></span>
<span class="n">bindkey</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"></span>
<span class="n">bindkey</span><span class="w"> </span><span class="s1">'^P'</span><span class="w"> </span><span class="n">history</span><span class="o">-</span><span class="n">beginning</span><span class="o">-</span><span class="n">search</span><span class="o">-</span><span class="n">backward</span><span class="w"></span>
<span class="n">bindkey</span><span class="w"> </span><span class="s1">'^N'</span><span class="w"> </span><span class="n">history</span><span class="o">-</span><span class="n">beginning</span><span class="o">-</span><span class="n">search</span><span class="o">-</span><span class="n">forward</span><span class="w"></span>

<span class="n">setopt</span><span class="w"> </span><span class="n">no_check_jobs</span><span class="w"></span>
<span class="n">setopt</span><span class="w"> </span><span class="n">no_hup</span><span class="w"></span>

<span class="n">setopt</span><span class="w"> </span><span class="n">print_eight_bit</span><span class="w"></span>

<span class="k">export</span><span class="w"> </span><span class="n">LSCOLORS</span><span class="o">=</span><span class="n">gxfxcxdxbxegedadagacad</span><span class="w"></span>
<span class="n">zstyle</span><span class="w"> </span><span class="s1">':completion:*:default'</span><span class="w"> </span><span class="n">list</span><span class="o">-</span><span class="n">colors</span><span class="w"> </span><span class="o">$</span><span class="n">LSCOLORS</span><span class="w"></span>

<span class="n">alias</span><span class="w"> </span><span class="n">ls</span><span class="o">=</span><span class="s2">"ls -vG"</span><span class="w"></span>
<span class="n">alias</span><span class="w"> </span><span class="n">la</span><span class="o">=</span><span class="s1">'ls -aF'</span><span class="w"></span>
<span class="n">alias</span><span class="w"> </span><span class="n">ll</span><span class="o">=</span><span class="s1">'ls -h -laF'</span><span class="w"></span>

<span class="n">alias</span><span class="w"> </span><span class="n">mv</span><span class="o">=</span><span class="s1">'mv -v'</span><span class="w"></span>
<span class="n">alias</span><span class="w"> </span><span class="n">cp</span><span class="o">=</span><span class="s1">'cp -v'</span><span class="w"></span>
<span class="n">alias</span><span class="w"> </span><span class="n">rm</span><span class="o">=</span><span class="s1">'rm -vi'</span><span class="w"></span>
<span class="n">alias</span><span class="w"> </span><span class="n">grep</span><span class="o">=</span><span class="s1">'grep --color'</span><span class="w"></span>

<span class="n">alias</span><span class="w"> </span><span class="n">du</span><span class="o">=</span><span class="s1">'du -h'</span><span class="w"></span>
<span class="n">alias</span><span class="w"> </span><span class="n">df</span><span class="o">=</span><span class="s1">'df -h'</span><span class="w"></span>

<span class="n">autoload</span><span class="w"> </span><span class="o">-</span><span class="n">U</span><span class="w"> </span><span class="n">compinit</span><span class="w"></span>
<span class="n">compinit</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"></span>

<span class="n">autoload</span><span class="w"> </span><span class="n">colors</span><span class="w"></span>
<span class="n">colors</span><span class="w"></span>

<span class="c1"># VCS settings</span><span class="w"></span>
<span class="c1"># http://liosk.blog103.fc2.com/blog-entry-209.html</span><span class="w"></span>
<span class="n">autoload</span><span class="w"> </span><span class="o">-</span><span class="n">Uz</span><span class="w"> </span><span class="n">vcs_info</span><span class="w"></span>
<span class="n">precmd</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">psvar</span><span class="o">=</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">LANG</span><span class="o">=</span><span class="n">en_US</span><span class="o">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span><span class="w"> </span><span class="n">vcs_info</span><span class="w"></span>
<span class="w">    </span><span class="n">psvar</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=$</span><span class="n">vcs_info_msg_0_</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">PROMPT</span><span class="o">=</span><span class="s2">"%{${fg[green]}%}[%n@%m %*] %{${fg[magenta]}%}%(!.#.&gt;) %{${reset_color}%}"</span><span class="w"></span>
<span class="n">PROMPT2</span><span class="o">=</span><span class="s2">"%{${fg[cyan]}%}%_&gt; %{${reset_color}%}"</span><span class="w"></span>
<span class="n">SPROMPT</span><span class="o">=</span><span class="s2">"%{${fg[red]}%}correct: %R -&gt; </span><span class="si">%r</span><span class="s2"> %{${reset_color}%}"</span><span class="w"></span>
<span class="n">RPROMPT</span><span class="o">=</span><span class="s2">"%{${fg[green]}%}[%{${fg[red]}%}%~%{${fg[white]}%}%1v%{${fg[green]}%}]%{${reset_color}%}"</span><span class="w"></span>
</pre></div>

<p>ちなみに最近はプロンプトに<code>starship</code>を使っているが、このマシンでインストールしようとしても失敗したので独自に設定している。</p>
<hr>
<h4>ファイルサーバ(samba)関連の設定</h4>
<h5>fstabの設定</h5>
<p>外付けHDDのUUIDを調べてシステム起動時に自動的にマウントされるように設定する。</p>
<div class="code"><pre class="code literal-block">$ sudo blkid -o list  <span class="c1"># UUIDを調べる</span>
$ sudo mkdir /mnt/hdd /mnt/hdd2  <span class="c1"># マウントポイントを作成</span>
$ sudo vim /etc/fstab
</pre></div>

<p>fstabには下記のような感じで書く。<code>${uuidN}</code>の部分は上記で調べたものに置き換えること。</p>
<div class="code"><pre class="code literal-block">UUID="<span class="cp">${</span><span class="n">uuid1</span><span class="cp">}</span>" /mnt/hdd hfsplus nofail,defaults,force 0 0
UUID="<span class="cp">${</span><span class="n">uuid2</span><span class="cp">}</span>" /mnt/hdd2 ext4 nofail,defaults 0 0
</pre></div>

<p>記述後、再起動して無事にマウントされているかを確認する。
nofailの記述は仮にマウントできなかった場合であってもエラーとして扱わないための指定である。
(実際、hfsplusフォーマットのディスクのマウントは<code>sudo apt install hfsprogs</code>が必要であったためこの記述を付けていない場合にemergency modeに突入してしまった。)</p>
<p>UUIDは外付けHDDに固有であるためか以前と変わっていなかったため、引き継ぎ元のマシンのfstabの追記内容をそのまま使い回すことができた。</p>
<h5>
<code>/etc/smb.conf</code>の設定およびavahi-daemonの設定をする</h5>
<p>詳細は割愛するが<a href="https://www.hiromasa.info/posts/23/">前回の記事</a>を参考のこと。
ここも<code>smb.conf</code>内のinterface名を変えたぐらいで基本的に元の設定ファイルをそのまま使い回すことができた。</p>
<h5>sambaアクセス用のユーザーを追加する</h5>
<p><code>guest ok</code>にしていてもTimeMachineバックアップの時には書き込み権限を持ったユーザーが登録されている必要があったので下記で設定しておく。</p>
<p><code>sudo smbpasswd -a ${username}</code></p>
<hr>
<h4>VPNサーバーの設定</h4>
<h5>SoftEtherの32bit対応版をダウンロードしてビルドする</h5>
<p><a href="http://www.softether-download.com/ja.aspx?product=softether">ここ</a>から条件に合うものを落としてきてmakeする。makeの際にライセンスの同意などを求められる。
ビルドした後は<code>/usr/local</code>に移動しておく。</p>
<div class="code"><pre class="code literal-block">$ wget https://jp.softether-download.com/files/softether/v4.34-9745-rtm-2020.04.05-tree/Linux/SoftEther_VPN_Server/32bit_-_Intel_x86/softether-vpnserver-v4.34-9745-rtm-2020.04.05-linux-x86-32bit.tar.gz
$ tar zxvf softether-vpnserver-v4.34-9745-rtm-2020.04.05-linux-x86-32bit.tar.gz
$ <span class="nb">cd</span> vpnserver
$ make
$ <span class="nb">cd</span> ..
$ mv vpnserver /usr/local/
</pre></div>

<h5>systemdの設定</h5>
<p><code>/etc/systemd/system/vpnserver.service</code>として下記ファイルを作成する。</p>
<div class="code"><pre class="code literal-block"><span class="k">[Unit]</span><span class="w"></span>
<span class="na">Description</span><span class="o">=</span><span class="s">SoftEther VPN Server</span><span class="w"></span>
<span class="na">After</span><span class="o">=</span><span class="s">network.target network-online.target</span><span class="w"></span>

<span class="k">[Service]</span><span class="w"></span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/local/vpnserver/vpnserver start</span><span class="w"></span>
<span class="na">ExecStop</span><span class="o">=</span><span class="s">/usr/local/vpnserver/vpnserver stop</span><span class="w"></span>
<span class="na">Type</span><span class="o">=</span><span class="s">forking</span><span class="w"></span>
<span class="na">RestartSec</span><span class="o">=</span><span class="s">3s</span><span class="w"></span>

<span class="k">[Install]</span><span class="w"></span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span><span class="w"></span>
</pre></div>

<h5>bridgeとtapデバイスの作成</h5>
<p>下記のようなスクリプトを作成しsudoで実行する。</p>
<div class="code"><pre class="code literal-block"><span class="ch">#!/bin/bash</span>
<span class="c1"># vim:fileencoding=utf-8</span>

<span class="nv">ip_addr</span><span class="o">=</span><span class="s2">"192.168.xxx.xxx/xx"</span>
<span class="nv">gateway_addr</span><span class="o">=</span><span class="s2">"192.168.xxx.xxx"</span>
<span class="nv">interface</span><span class="o">=</span><span class="s2">"enp1s0"</span>

<span class="nv">bridge_name</span><span class="o">=</span><span class="s2">"br0"</span>
<span class="nv">tap_device_name</span><span class="o">=</span><span class="s2">"tap_softether"</span>

<span class="nb">echo</span> <span class="s2">"create bridge interface"</span>
/usr/bin/nmcli connection add <span class="nb">type</span> bridge ifname <span class="si">${</span><span class="nv">bridge_name</span><span class="si">}</span>
<span class="nb">echo</span> <span class="s2">"disable STP"</span>
/usr/bin/nmcli connection modify bridge-<span class="si">${</span><span class="nv">bridge_name</span><span class="si">}</span> bridge.stp no
<span class="nb">echo</span> <span class="s2">"modify bridge"</span>
/usr/bin/nmcli connection modify bridge-<span class="si">${</span><span class="nv">bridge_name</span><span class="si">}</span> ipv4.method manual ipv4.addresses <span class="si">${</span><span class="nv">ip_addr</span><span class="si">}</span> ipv4.gateway <span class="si">${</span><span class="nv">gateway_addr</span><span class="si">}</span>
<span class="nb">echo</span> <span class="s2">"connect </span><span class="si">${</span><span class="nv">interface</span><span class="si">}</span><span class="s2"> to bridge"</span>
/usr/bin/nmcli connection add <span class="nb">type</span> bridge-slave ifname <span class="si">${</span><span class="nv">interface</span><span class="si">}</span> master bridge-<span class="si">${</span><span class="nv">bridge_name</span><span class="si">}</span>
<span class="nb">echo</span> <span class="s2">"connect tap to bridge"</span>
/usr/bin/nmcli connection add <span class="nb">type</span> bridge-slave ifname <span class="si">${</span><span class="nv">tap_device_name</span><span class="si">}</span> master bridge-<span class="si">${</span><span class="nv">bridge_name</span><span class="si">}</span>
<span class="nb">echo</span> <span class="s2">"up tap device"</span>
/usr/bin/nmcli connection up bridge-<span class="si">${</span><span class="nv">bridge_name</span><span class="si">}</span>
</pre></div>

<p>上記を実行すると下記のような出力が出る。</p>
<div class="code"><pre class="code literal-block"><span class="nv">create</span><span class="w"> </span><span class="nv">bridge</span><span class="w"> </span><span class="nv">interface</span><span class="w"></span>
接続<span class="w"> </span><span class="s1">'bridge-br0'</span><span class="w"> </span><span class="ss">(</span><span class="mi">0</span><span class="nv">aa0ae96</span><span class="o">-</span><span class="mi">6428</span><span class="o">-</span><span class="mi">4</span><span class="nv">f7e</span><span class="o">-</span><span class="nv">bc1c</span><span class="o">-</span><span class="nv">fa6f22f98cea</span><span class="ss">)</span><span class="w"> </span>が正常に追加されました。<span class="w"></span>
<span class="nv">disable</span><span class="w"> </span><span class="nv">STP</span><span class="w"></span>
<span class="nv">modify</span><span class="w"> </span><span class="nv">bridge</span><span class="w"></span>
<span class="k">connect</span><span class="w"> </span><span class="nv">enp1s0</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">bridge</span><span class="w"></span>
接続<span class="w"> </span><span class="s1">'bridge-slave-enp1s0'</span><span class="w"> </span><span class="ss">(</span><span class="nv">ec87d050</span><span class="o">-</span><span class="nv">f6ae</span><span class="o">-</span><span class="mi">4</span><span class="nv">ca8</span><span class="o">-</span><span class="nv">adbf</span><span class="o">-</span><span class="mi">7</span><span class="nv">b1f0e4eb1b6</span><span class="ss">)</span><span class="w"> </span>が正常に追加されました。<span class="w"></span>
<span class="k">connect</span><span class="w"> </span><span class="nv">tap</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">bridge</span><span class="w"></span>
接続<span class="w"> </span><span class="s1">'bridge-slave-tap_softether'</span><span class="w"> </span><span class="ss">(</span><span class="nv">f262c26c</span><span class="o">-</span><span class="mi">2799</span><span class="o">-</span><span class="mi">4</span><span class="nv">c9b</span><span class="o">-</span><span class="nv">b149</span><span class="o">-</span><span class="mi">9</span><span class="nv">d1b3c44f8ce</span><span class="ss">)</span><span class="w"> </span>が正常に追加されました。<span class="w"></span>
<span class="nv">up</span><span class="w"> </span><span class="nv">tap</span><span class="w"> </span><span class="nv">device</span><span class="w"></span>
接続が正常にアクティベートされました<span class="w"> </span><span class="ss">(</span><span class="nv">master</span><span class="w"> </span><span class="nv">waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">slaves</span><span class="ss">)</span><span class="w"> </span><span class="ss">(</span><span class="nv">D</span><span class="o">-</span><span class="nv">Bus</span><span class="w"> </span>アクティブパス:<span class="w"> </span><span class="o">/</span><span class="nv">org</span><span class="o">/</span><span class="nv">freedesktop</span><span class="o">/</span><span class="nv">NetworkManager</span><span class="o">/</span><span class="nv">ActiveConnection</span><span class="o">/</span><span class="mi">3</span><span class="ss">)</span><span class="w"></span>
</pre></div>

<p>この後に再起動を行い、<code>ip addr</code>でIPアドレスが割り振られていたり、<code>ip link show</code>でbr0のSTATEがUpになっていれば問題ないと思われる。</p>
<p>なお<code>sudo apt install bridge-utils</code>を実行すると <code>/sbin/brctl</code>が使えるようになるが、今回は直接は不要であった。
また上記スクリプトではnmcliを使っているがipコマンドでもどうやら作成できるらしい。</p>
<h5>VPNサーバーの設定の読み込み</h5>
<p>移行元で予め<code>vpncmd</code>のConfigGetを実行し保存しておく。
これは</p>
<div class="code"><pre class="code literal-block">$ /usr/local/vpnserver/vpncmd
  &gt; * <span class="m">1</span>. VPN Server または VPN Bridgeの管理 を実行
  &gt; * 何も指定せずにEnterを押すことでローカルのサーバーに接続
  &gt; * 更に何も指定せずにEnterを押すことでサーバー管理モードに入る
  &gt; * 管理パスワードを入力
  VPN Server&gt; ConfigGet 保存先パス
</pre></div>

<p>と実行することで保存が可能である。この設定ファイルを引き継ぎ先のマシンで読み込ませることを考える。</p>
<p>まず、<code>sudo systemctl enable vpnserver</code>を実行し前述のsystemd用の設定によるサービスを有効化する。
続いて<code>sudo systemctl start vpnserver</code>でVPNサーバーを起動する。</p>
<p>この上で<code>/usr/local/vpnserver/vpncmd</code>を実行し、移行元での保存時と同様に1を指定の上で無指定でEnterを2回実行することでサーバー管理モードに入る。
ここで<code>ConfigSet</code>を実行すると設定ファイルのパスを尋ねられるので、入力することで設定の読み込みが可能である。
<a href="https://ja.softether.org/4-docs/1-manual/3/3.3#.E5.88.A5.E3.81.AE.E3.82.B3.E3.83.B3.E3.83.94.E3.83.A5.E3.83.BC.E3.82.BF.E3.81.B8.E3.81.AE.E3.82.B3.E3.83.B3.E3.83.95.E3.82.A3.E3.82.B0.E3.83.AC.E3.83.BC.E3.82.B7.E3.83.A7.E3.83.B3.E3.83.95.E3.82.A1.E3.82.A4.E3.83.AB.E3.81.AE.E7.A7.BB.E5.8B.95">ここ</a>によればこの時点で元マシンの環境は復元できるとのことである。</p>
<h5>ルーターで通信に必要なポートを開放する</h5>
<p>50, 51, 500, 4500番ポートの通信をホストマシンのIPアドレスに対して許可するようにルーターの設定を施した。</p>
<h5>接続できない原因を探す</h5>
<p>元マシンでの設定が正しければ上記までの設定で接続できるようになるはずだが案の定接続できない。
そこで<code>/usr/local/vpnserver</code>以下に存在する<code>secure_log</code>や<code>server_log</code>といったログ見て原因を推察する。
ここでは<code>server_log</code>以下に存在するlogにおける</p>
<div class="code"><pre class="code literal-block"><span class="mf">2020</span><span class="o">-</span><span class="mf">11</span><span class="o">-</span><span class="mf">21</span><span class="w"> </span><span class="n">xx</span><span class="p">:</span><span class="n">xx</span><span class="p">:</span><span class="n">xx</span><span class="mf">.</span><span class="n">xxx</span><span class="w"> </span><span class="n">L2TP</span><span class="w"> </span><span class="n">PPP</span><span class="w"> </span><span class="n">セッション</span><span class="w"> </span><span class="err">[</span><span class="n">xxx</span><span class="mf">.</span><span class="n">xxx</span><span class="mf">.</span><span class="n">xxx</span><span class="mf">.</span><span class="n">xxx</span><span class="p">:</span><span class="n">xxxx</span><span class="err">]</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="n">DHCP</span><span class="w"> </span><span class="n">サーバーからの</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="n">アドレスの取得に失敗しました</span><span class="err">。</span><span class="w"></span>
<span class="w">  </span><span class="n">PPP</span><span class="w"> </span><span class="n">の通信を受諾するためには</span><span class="w"> </span><span class="n">DHCP</span><span class="w"> </span><span class="n">サーバーが必要です</span><span class="err">。</span><span class="w"></span>
<span class="w">  </span><span class="n">仮想</span><span class="w"> </span><span class="n">HUB</span><span class="w"> </span><span class="n">の</span><span class="w"> </span><span class="n">Ethernet</span><span class="w"> </span><span class="n">セグメント上で</span><span class="w"> </span><span class="n">DHCP</span><span class="w"> </span><span class="n">サーバーが正しく動作しているかどうか確認してください</span><span class="err">。</span><span class="w"></span>
<span class="w">  </span><span class="n">DHCP</span><span class="w"> </span><span class="n">サーバーを用意することができない場合は</span><span class="err">、</span><span class="n">仮想</span><span class="w"> </span><span class="n">HUB</span><span class="w"> </span><span class="n">の</span><span class="w"> </span><span class="n">SecureNAT</span><span class="w"> </span><span class="n">機能を用いることもできます</span><span class="err">。</span><span class="w"></span>
</pre></div>

<p>という記述から<code>SecureNat</code>が有効化されていないことが分かったため、<code>vpncmd</code>を実行し仮想ハブの管理から<code>SecureNatEnable</code>を実行したところ、無事に接続されるようになった。</p>
<h5>SecureNATの利用を使用しない設定への変更</h5>
<p>前節の設定のままだとVPNでSecureNAT機能によりIPアドレスが割り振られるが、このままだとホストマシンにSSHアクセスできなかったため元マシンの設定を見返したところ<code>/etc/network/interfaces</code>を明示的に指定していたことが分かった。
よって<code>vpncmd</code>で<code>SecureNATDisable</code>を実行した上で再度<code>SecureNat</code>を停止した上で下記のような設定を<code>/etc/network/interfaces</code>に追記した。</p>
<div class="code"><pre class="code literal-block">auto enp1s0
iface enp1s0 inet manual

auto br0
iface br0 inet static
  address 192.168.xxx.xxx
  netmask 255.255.xxx.xxx
  gateway 192.168.xxx.xxx
  bridge_ports enp1s0 tap_softether
  dns-nameservers 192.168.xxx.xxx
</pre></div>

<p>NetworkManagerは<code>/etc/NetworkManager/NetworkManager.conf</code>において下記のような設定</p>
<div class="code"><pre class="code literal-block"><span class="k">[ifupdown]</span><span class="w"></span>
<span class="na">managed</span><span class="o">=</span><span class="s">false</span><span class="w"></span>
</pre></div>

<p>となっている場合、<code>/etc/network/interface</code>によって管理されているデバイスはNetworkManagerで制御を行わないとのことである。
この上で<code>sudo systemctl restart networking</code>を行うと<code>SecureNAT</code>がdisableとなっている場合でも接続が可能となった。</p>
<p>しかし、この状態で再起動を行うとやはり接続できない状態に戻ってしまう。
調べたところ<code>sudo systemctl restart networking</code>を行った後は下記状態</p>
<div class="code"><pre class="code literal-block">$ /sbin/brctl show
bridge name     bridge id               STP enabled     interfaces
br0             <span class="m">8000</span>.0016cba5df15       no              enp1s0
                                                        tap_softether
</pre></div>

<p>となっているが、マシンの再起動直後は</p>
<div class="code"><pre class="code literal-block">$ /sbin/brctl show
bridge name     bridge id               STP enabled     interfaces
br0             <span class="m">8000</span>.0016cba5df15       no              enp1s0
</pre></div>

<p>という状態になっていることが分かった。
つまりbr0に対して起動直後は何らかの理由で<code>tap_softether</code>のtapデバイスがbr0に接続されていないことが原因となっていることが考えられ、
実際に<code>/sbin/brctl addif br0 tap_softether</code>を実行することで明示的に追加を行った場合はVPN接続が可能となった。</p>
<p>これを受けて<code>/etc/systemd/system/vpnserver.service</code>に下記のように<code>ExecStartPost</code>を追加した。</p>
<div class="code"><pre class="code literal-block"><span class="k">[Service]</span><span class="w"></span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/local/vpnserver/vpnserver start</span><span class="w"></span>
<span class="na">ExecStartPost</span><span class="o">=</span><span class="s">/bin/sleep 10 ; /sbin/brctl addif br0 tap_softether</span><span class="w"></span>
</pre></div>

<p>sleepの秒数の後のセミコロンは10とセミコロンの間にスペースを空けないとエラーが生じるため注意が必要である。
これによりマシン再起動後も手動での操作なしにVPN接続が可能な状態となった。</p>
<hr>
<h3>まとめ</h3>
<p>古いMac miniにDebianを入れてファイルサーバ・VPNサーバとして復活させる手順のメモを記した。
稼働させたばかりであり、そもそも古いマシンであるため、いつまで持つか不明であるがこのまましばらく運用してみようと思う。</p>
                </div>
            </article>
</div>
    
        <ul class="pager postindexpager clearfix">
<li class="next"><a href="index-8.html" rel="next">過去の記事</a></li>
        </ul>
<script>var disqus_shortname="hiromasa-info";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><!--End of body content--><footer id="footer">
            Contents © 2022         <a href="mailto:stoicheia1986@gmail.com">Hiromasa OHASHI</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
<!-- twitter -->
<a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><!-- facebook --><div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = 'https://connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.11';
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script><div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="true" data-share="true"></div>

<!-- hatena -->
<a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-counter" title="このエントリーをはてなブックマークに追加">
<img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;"></a>
<script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script></footer>
</div>
</div>


        <script src="assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
