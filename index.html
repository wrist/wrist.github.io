<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="ja">
<head>
<meta charset="utf-8">
<meta name="description" content="blog by Hiromasa OHASHI">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>hiromasa.info</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS (ja)" hreflang="ja" href="rss.xml">
<link rel="alternate" type="application/rss+xml" title="RSS (en)" hreflang="en" href="en/rss.xml">
<link rel="canonical" href="http://www.hiromasa.info/">
<link rel="next" href="index-8.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: http://*.google-analytics.com https://*.hiromasa.info https://*.google-analytics.com https://code.jquery.com http://*.disqus.com https://disqus.com https://*.disqus.com https://*.disquscdn.com https://*.cloudinary.com http://www.gravatar.com https://www.googletagmanager.com https://*.twitter.com http://*.facebook.com https://*.facebook.com https://*.facebook.net http://*.hatena.ne.jp https://*.st-hatena.com https://cdnjs.cloudflare.com https://fonts.gstatic.com;">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-48887105-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-48887105-1');
</script><!-- End Google Analytics --><!-- for facebook button --><style>
.fb-like {
    display: inline;
}
#fb-root {
    display: inline;
}
.fb_iframe_widget > span {
    vertical-align: baseline !important; 
}
</style>
<link rel="prefetch" href="posts/27/" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">本文を読み飛ばす</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href=".">

            <span id="blog-title">hiromasa.info</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav">
<li class="nav-item"><a href="en/" rel="alternate" hreflang="en" class="nav-link">English</a></li>

                    
                    
                    
            </ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="archive.html" class="nav-link">文書一覧</a>
                </li>
<li class="nav-item">
<a href="categories/" class="nav-link">タグ</a>
                </li>
<li class="nav-item">
<a href="pages/about/index.html" class="nav-link">about</a>
                </li>
<li class="nav-item">
<a href="pages/slides/index.html" class="nav-link">slide一覧</a>
                </li>
<li class="nav-item">
<a href="jupyterlite/lab/" class="nav-link">my jupyterlite</a>
                </li>
<li class="nav-item">
<a href="rss.xml" class="nav-link">RSSフィード</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
    
        

    
        
    <div class="postindex">
            <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/27/" class="u-url">高速なconda代替コマンド mambaとビルドツールboa</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Hiromasa OHASHI
                    </span></p>
            <p class="dateline">
            <a href="posts/27/" rel="bookmark">
            <time class="published dt-published" datetime="2022-12-13T00:00:00+09:00" itemprop="datePublished" title="2022-12-13 00:00">2022-12-13 00:00</time></a>
            </p>
                        <p class="commentline">
    
    <a href="posts/27/#disqus_thread" data-disqus-identifier="cache/posts/27.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <p>この記事は<a href="https://qiita.com/advent-calendar/2022/python">Qiitaアドベントカレンダー 2022 Python</a> 13日目の記事です。</p>
<h3>高速な<code>conda</code>代替コマンド<code>mamba</code>
</h3>
<p><code>mamba</code>は<code>conda</code>コマンドの代わりに使用することができるPythonライブラリやパッケージ管理に用いることが可能なコマンドラインツールです。 <code>C++</code>による記述や<code>libsolv</code>などのライブラリを活用することによって高速に動作することを特徴としており、最近バージョン1.0が公開されました。
当方で<a href="https://medium.com/pydata-osaka/releasing-mamba-1-0-%E3%81%AE%E6%97%A5%E6%9C%AC%E8%AA%9E%E8%A8%B3-9f71af3a7dd7">関連する記事の翻訳</a>をPyData OsakaのMedium上で公開したため、詳細についてはこちらをご覧いただければと思います。
上記記事でも触れられていますが、<code>mamba</code>は<code>conda</code>とほぼ互換性のあるCLIインタフェースを持っているため、もし既にパッケージ管理に<code>conda</code>を使っている場合はそのコマンドを<code>mamba</code>に置き換えるだけで使用することが可能となります。</p>
<h4>
<code>mamba</code>の導入</h4>
<p>詳細は<a href="https://mamba.readthedocs.io/en/latest/installation.html">こちら</a>を参照いただければと思いますが、既にcondaが導入されている場合は<code>conda install mamba -n base -c conda-forge</code>でインストールを行うことができます。
mambaの使用方法についてはcondaと同一であるためここでは割愛させていただきます。</p>
<h4><code>micromamba</code></h4>
<p>前述の翻訳記事にも記載がありますが、更に最近は完全にC++のみで書かれた<code>micromamba</code>の開発が進んでいます。シングルバイナリで提供され、非常に小さく、更にベースとなる環境を必要としないことを特徴としています。依存関係についても完全に静的リンクされた状態で配布されているため、適当なところに配置して実行することが可能となります。<a href="https://mamba.readthedocs.io/en/latest/installation.html">ドキュメント</a>にはminicondaの代わりとして環境構築をゼロから行う場合に使用可能であるような旨が書かれています。</p>
<h4>
<code>micromamba</code>の導入</h4>
<p>macosであればhomebrewを入れた状態で<code>brew install --cask micromamba</code>のように導入が可能です。
また、homebrewがない環境では<code>curl micro.mamba.pm/install.sh | zsh</code>としても導入が可能です。
linuxの場合は<code>curl micro.mamba.pm/install.sh | bash</code>とzshをbashに置き換えてください。
windowsの場合は<a href="https://mamba.readthedocs.io/en/latest/installation.html">ドキュメント</a>を参照ください。</p>
<h4>
<code>micromamba</code>の使用方法</h4>
<p><code>micromamba</code>は<code>conda</code>や<code>mamba</code>のCLIのサブセットを持っているためほとんど同じ様な感じで使うことができます。
詳細は<a href="https://mamba.readthedocs.io/en/latest/user_guide/micromamba.html">ドキュメント</a>を参照いただければと思いますが、<code>--help</code>でサブコマンドの一覧が表示でき、</p>
<div class="code"><pre class="code literal-block">$ micromamba --help

Subcommands:
  shell                       Generate shell init scripts
  create                      Create new environment
  install                     Install packages <span class="k">in</span> active environment
  update                      Update packages <span class="k">in</span> active environment
  repoquery                   Find and analyze packages <span class="k">in</span> active environment or channels
  remove                      Remove packages from active environment
  list                        List packages <span class="k">in</span> active environment
  package                     Extract a package or bundle files into an archive
  clean                       Clean package cache
  config                      Configuration of micromamba
  info                        Information about micromamba
  constructor                 Commands to support using micromamba <span class="k">in</span> constructor
  env                         List environments
  activate                    Activate an environment
  run                         Run an executable <span class="k">in</span> an environment
  ps                          Show, inspect or <span class="nb">kill</span> running processes
  auth                        Login or <span class="nb">logout</span> of a given host
  search                      Find packages <span class="k">in</span> active environment or channels
</pre></div>

<p>ライブラリの個別インストールは<code>micromamba install xtensor -c conda-forge</code>で可能です。<code>-c</code>はインストール元のchannelを<code>conda-forge</code>に指定していることを表ます。
また、仮想環境作成も<code>conda</code>や<code>mamba</code>と同様に<code>micromamba create -n xtensor_env xtensor xsimd -c conda-forge</code>ののちに<code>micromamba activate xtensor_env</code>などでアクティベーションが可能です。</p>
<p>ライブラリはライブラリを列挙したテキストファイルか、または<code>env.yal</code>からインストールすることもできます。
テキストファイルの場合は、</p>
<div class="code"><pre class="code literal-block">xtensor
numpy 1.19
xsimd &gt;=7.4
</pre></div>

<p>という内容のファイルを<code>spec_file.txt</code>として保存した上で、<code>micromamba create -n from_file -f spec_file.txt -c conda-forge</code>で実行することが可能です。</p>
<p>また、<code>env.yml</code>は下記のようなyamlファイルです。</p>
<div class="code"><pre class="code literal-block"><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">testenv</span><span class="w"></span>
<span class="nt">channels</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge</span><span class="w"></span>
<span class="nt">dependencies</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python &gt;=3.6,&lt;3.7</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ipykernel &gt;=5.1</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ipywidgets</span><span class="w"></span>
</pre></div>

<p>これを元にする場合は<code>micromamba create -f env.yml</code>として環境構築が可能です。<code>-c conda-forge</code>を指定しなくて済む様になるので便利ですね。</p>
<h4>
<code>micromamba</code>の活用方法</h4>
<p><code>micromamba</code>はシングルバイナリで提供できインストールも容易であることから、CI/CDなどで使用することも想定されています。
冒頭の翻訳記事にも出てきますが、GitHub Actionsで利用可能な<a href="https://github.com/mamba-org/provision-with-micromamba">provision-with-micromamba</a>、micromambaが使用可能な軽量Dockerイメージである<a href="https://github.com/mamba-org/micromamba-docker">micromamba-docker</a>、VSCodeでの開発で活用できる<a href="https://github.com/mamba-org/micromamba-devcontainer">micromamba-devcontainer</a>などが公開されています。</p>
<p>実際にWebAssembly向けのパッケージを格納している<a href="https://github.com/emscripten-forge/recipes/blob/main/.github/workflows/build_recipes.yaml">Emscripten-forgeのActions</a>では、この様な目的でMicromambaを使用しています。</p>
<h3>Mamba meets Jupyterlite</h3>
<p><code>Emscripten-forge</code>の話題を出したので、また別の翻訳記事である<a href="https://medium.com/pydata-osaka/mamba-meets-jupyterlite%E3%81%AE%E6%97%A5%E6%9C%AC%E8%AA%9E%E8%A8%B3-68d0823d767d">mamba meets jupyterlite</a>についてもここで貼っておきたいと思います。この記事は更に別の翻訳記事である<a href="https://medium.com/pydata-osaka/jupyterlite-jupyter-%EF%B8%8Fwebassembly-%EF%B8%8Fpython%E3%81%AE%E6%97%A5%E6%9C%AC%E8%AA%9E%E8%A8%B3-1f228a9d97d1">JupyterLite:Jupyter❤️WebAssembly❤️Python</a>の翻訳記事を前提にしているため、合わせて読んでいただけると幸いです。</p>
<p>ざっくり書きますと、WebAssemblyを活用することによりPythonインタプリタをブラウザ上で動作することを可能にした<code>pyodide</code>というものが存在し、更にこれを活用することでサーバーを必要としないブラウザのみで動作するJupyter環境である<code>Jupyterlite</code>というものが存在しています。
このJupyterlite上ではピュアPythonのみで書かれたライブラリに関しては<code>pyodide</code>の<a href="https://pyodide.org/en/stable/usage/api/micropip-api.html">micropip</a>を用いることでJupyterliteへの導入が可能となっていますが 、 一方で C拡張を伴うようなライブラリについては(WebAssemblyのコンパイルが必要となることなどから)単純な導入が困難となっておりました。
これを解決するためには、WebAssemblyプラットフォーム向けにあらかじめビルドされた状態のcondaパッケージを配布することが必要となります。
このために、<a href="https://github.com/emscripten-forge/recipes">emscripten-forge/recipes</a>のリポジトリにおいてパッケージのビルド方法を管理するためのレシピ群が管理され、 パッケージのホスティングには<a href="https://github.com/mamba-org/quetz">Quetz</a>というFastAPIを用いたcondaパッケージ用のサーバーが用いられています。</p>
<p>これらの機構を用いることで、<code>emscripten-32</code>向けの環境を下記の様に構築できるようになりました。</p>
<div class="code"><pre class="code literal-block">$ micromamba create -n my-env --platform<span class="o">=</span>emscripten-32 <span class="se">\ </span>
    -c https://repo.mamba.pm/emscripten-forge <span class="se">\ </span>
    -c https://repo.mamba.pm/conda-forge <span class="se">\</span>
    python ipython numpy jedi
</pre></div>

<p>jupyterliteではこのWebAssembly向けにビルド・配布されたパッケージを使うために、<a href="https://github.com/jupyter-xeus/xeus-python">xeus-python</a>を用いているそうです。
自分も完璧には理解しきれてはいませんが、jupyterliteを静的サイトとして構築する際に使用する<code>jupyter lite build</code>コマンドにおいて、下記の様な指定を行うことでXeusPython環境に存在するパッケージをPythonランタイム内にプリインストールすることが可能となるとのことです。</p>
<div class="code"><pre class="code literal-block">$ jupyter lite build --XeusPythonEnv.packages<span class="o">=</span><span class="se">\</span>
    numpy,<span class="se">\</span>
    matplotlib,<span class="se">\</span>
    ipyleaflet
</pre></div>

<h3>ビルドツール<code>boa</code>
</h3>
<p>上記のWebAssembly向けのパッケージのビルドは<a href="https://github.com/emscripten-forge/recipes/blob/main/.github/workflows/build_recipes.yaml">Emscripten-forgeのActions</a>内で呼ばれている<a href="https://github.com/emscripten-forge/recipes/blob/main/builder.py">builder.py</a>で行われていますが、ここでビルドツールの<a href="https://github.com/mamba-org/boa">boa</a>というものが使われています。
<code>boa</code>は<code>libmamba</code>を用いることで<code>conda-build</code>よりも高速なビルドを実現するためのツールであるとのことです。
<code>boa</code>は3種類のツールを含んでおり、<code>conda build</code>をmambaをsolverとしたものに置き換える<code>conda mambabuild</code>、新しい形式のレシピを用いたビルドにおける情報の表示を行う<code>boa render</code>、そのレシピをもとにビルドを行う<code>boa build</code>を含んでいます。</p>
<p><code>boa</code>のドキュメントは<a href="https://boa-build.readthedocs.io/en/latest/">ここ</a>に存在しており、<a href="https://boa-build.readthedocs.io/en/latest/getting_started.html">Getting Started</a>には、<code>mamba install boa -c conda-forge</code>(mambaの代わりにcondaでも可能)で<code>boa</code>のインストールを行うことができるとあります。</p>
<h4>
<code>conda mambabuild</code>のメリット</h4>
<p>メリットについては<a href="https://boa-build.readthedocs.io/en/latest/mambabuild.html">ここ</a>に3つ載っており、</p>
<ol>
<li>より高速な依存解決速度: 複雑な環境に対しては、mambaはcondaよりもかなり高速なビルドが可能</li>
<li>より良いエラーメッセージ: 依存関係が解決できない環境において、解読が困難なcondaは大量のエラーメッセージを吐くが、Mambaはより理解しやすいメッセージを出力する</li>
<li>既存のレシピおよびconda-buildのCLIオプションとの完全な互換性がある(conda-buildに対してsolverの部分を置き換えるためのモンキーパッチを適用しているため)</li>
</ol>
<p>とのことです。</p>
<h4>
<code>boa</code>における新しいレシピフォーマット</h4>
<p><code>boa</code>は<code>conda build</code>で用いられる<code>meta.yaml</code>を置き換える新しいフォーマットである<code>recipe.yaml</code>を用いたビルドを行うことが可能です。
<a href="https://boa-build.readthedocs.io/en/latest/recipe_spec.html">このドキュメント</a>に詳細な記述があります。
parseを簡単にしたり、複数箇所への出力に関する一貫性のなさを解消したり、再起的なパースや依存性解決を防ぐために開発されたとの説明があります。</p>
<p><code>boa</code>のレシピは次の項目を備えています。</p>
<ul>
<li>context: Jinjaの文字列置換で後続の箇所で使用可能な変数の設定を行う</li>
<li>package: パッケージのトップレベルとなる 名前、バージョン、その他の情報を定義する</li>
<li>source: ： レシピのビルドのためにダウンロードが必要となるソースへのポインタ</li>
<li>build: レシピをどのようにビルドするかと、使用するビルド番号を定義する</li>
<li>requirements: パッケージのトップレベルにおける依存ライブラリを定義する</li>
<li>test: パッケージのトップレベルにおけるテストを定義する</li>
<li>outputs: レシピは複数の出力行うことができる。各々のoutputはパッケージと依存関係、テストのセクションを持ちことが可能であり持つべきである</li>
</ul>
<p>ドキュメント記載の例を下記に転記します。</p>
<div class="code"><pre class="code literal-block"><span class="c1"># "context variables"を設定(後でJinjaのexpressionとして使用可能)</span><span class="w"></span>
<span class="nt">context</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.1.0</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">imagesize</span><span class="w"></span>

<span class="c1"># トップレベルのパッケージ情報(nameとversion)</span><span class="w"></span>
<span class="nt">package</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">name</span><span class="nv"> </span><span class="s">}}"</span><span class="w"></span>
<span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">"{{</span><span class="nv"> </span><span class="s">version</span><span class="nv"> </span><span class="s">}}"</span><span class="w"></span>

<span class="c1"># ソースをどこから取得するかを定義</span><span class="w"></span>
<span class="nt">source</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://pypi.io/packages/source/{{ name[0] }}/{{ name }}/{{ name }}-{{ version }}.tar.gz</span><span class="w"></span>
<span class="w">  </span><span class="nt">sha256</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">f3832918bc3c66617f92e35f5d70729187676313caa60c187eb0f28b8fe5e3b5</span><span class="w"></span>

<span class="c1"># ビルド番号(バージョンは増加させないが、もし新しいビルドが生成されるのであれば増加させるべき)</span><span class="w"></span>
<span class="nt">build</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python -m pip install --no-deps --ignore-installed .</span><span class="w"></span>

<span class="c1"># ビルド時の実行時のrequirementsを記載</span><span class="w"></span>
<span class="nt">requirements</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">host</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip</span><span class="w"></span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python</span><span class="w"></span>

<span class="c1"># パッケージが期待通りに動作するかをバリデーションするためのテスト</span><span class="w"></span>
<span class="nt">test</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">imports</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">imagesize</span><span class="w"></span>

<span class="c1"># パッケージに関する情報</span><span class="w"></span>
<span class="nt">about</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">home</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/shibukawa/imagesize_py</span><span class="w"></span>
<span class="w">  </span><span class="nt">license</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MIT</span><span class="w"></span>
<span class="w">  </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">'Getting</span><span class="nv"> </span><span class="s">image</span><span class="nv"> </span><span class="s">size</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">png/jpeg/jpeg2000/gif</span><span class="nv"> </span><span class="s">file'</span><span class="w"></span>
<span class="w">  </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">    </span><span class="no">This module analyzes jpeg/jpeg2000/png/gif image header and</span><span class="w"></span>
<span class="w">    </span><span class="no">return image size.</span><span class="w"></span>
<span class="w">  </span><span class="nt">dev_url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/shibukawa/imagesize_py</span><span class="w"></span>
<span class="w">  </span><span class="nt">doc_url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://pypi.python.org/pypi/imagesize</span><span class="w"></span>
<span class="w">  </span><span class="nt">doc_source_url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/shibukawa/imagesize_py/blob/master/README.rst</span><span class="w"></span>

<span class="c1"># 下記はconda-forge特有の内容</span><span class="w"></span>
<span class="nt">extra</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">recipe-maintainers</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">somemaintainer</span><span class="w"></span>
</pre></div>

<p>また、<code>conda-build</code>との主な違いは下記の通りです。</p>
<ul>
<li>レシピのファイル名がmeta.yamlではなくrecipe.yamlとなった</li>
<li>出力がより複雑ではないふるまいとなり、キー名は名前だけではなくpackage/nameと同じレシピにおけるトップレベル階層と同じ(例: 単なるscriptではなくbuild/script)となる</li>
<li>暗黙のメタパッケージが出力に生じない</li>
<li>完全なJinja2サポートを含まない: 条件節がない または <code>{%</code> のサポートはなく, 文字列置換のみである. 変数は有効なYAMLファイルのトップレベルにおける"context"に記載できる</li>
<li>Jinjaの文字列補完は有効なYAMLとするためにクォーテーションが必要 e.g. - "{{ version }}"</li>
<li>セレクタはYAML辞書スタイルを用いる(conda-buildにおけるコメントの代わり). E.g. <code>- somepkg  # [osx]</code>の代わりに<code>- sel(osx): somepkg</code>と書く</li>
<li>
<code>conda-build</code>からセレクタの文法を使わずにスキップ条件のリストを使う命令をスキップする(e.g. ["osx", "win and py37"]はスキップ)</li>
</ul>
<h4>conda-buildからのレシピ構築</h4>
<p><code>conda-build</code>で用いていた既存のレシピ<code>meta.yaml</code>を<code>boa</code>の文法へとコンバートすることができます。そのコマンドは新しいレシピを標準出力に出力します。
結果を速く保存するために、<code>boa convert meta.yaml &gt; recipe.yaml</code>を使うことができ、<code>boa build ..</code>を実行してください。
変換プロセスは"シンプル"なレシピに対してのみ動作し、複雑なレシピの変換には手作業が必要となるであろうことに注意してください。</p>
<p>ここで実際に既存recipeを変換して...というところまで行きつきたかったのですが、時間切れに伴いここで一旦終了とさせていただきます。
追記する場合はその旨を記載いたします。</p>
<h3>PyData Osaka meetup #27</h3>
<p>以上に記載した内容+αを12/17(土) 13:00より開催予定の<a href="https://www.hiromasa.info/posts/27/">PyData Osakaのミートアップ</a>で紹介する予定です。
この記事で触れたmambaやboaについての紹介を行いたいと考えています。よろしければご参加ください。</p>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/26/" class="u-url">2022/10/22 PyData Osaka #026における JupyterLite関連の紹介記事</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Hiromasa OHASHI
                    </span></p>
            <p class="dateline">
            <a href="posts/26/" rel="bookmark">
            <time class="published dt-published" datetime="2022-10-22T00:00:00+09:00" itemprop="datePublished" title="2022-10-22 00:00">2022-10-22 00:00</time></a>
            </p>
                        <p class="commentline">
    
    <a href="posts/26/#disqus_thread" data-disqus-identifier="cache/posts/26.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <h2>2022/10/22 PyData Osaka Meetup #026におけるJupyterLite関連の紹介記事</h2>
<p>本記事はタイトルの通り<a href="https://pydataosaka.connpass.com/event/261492/">PyData Osaka Meetup #026</a>で使用する、主にJupyterLiteについて紹介するための記事となります。</p>
<h3>Jupyterliteに関する翻訳記事の紹介(前半)</h3>
<p><a href="https://github.com/PyDataOsaka/jupyterblog-translation">このリポジトリ</a>で翻訳した内容を<a href="https://medium.com/pydata-osaka">Medium</a>へと転記しています。
StarやMediumでのフォローをよろしくお願いします。</p>
<p>まずは<a href="https://jupyter.org/try-jupyter/lab/">ここ</a>をクリックしてJupyterliteを体験していただければと思います。</p>
<p>本日のイベントでは下記ブログ記事を読んでいきます。</p>
<ul>
<li><a href="https://github.com/PyDataOsaka/jupyterblog-translation/blob/main/posts/2021-07-13-jupyterlite-loves-webassembly.md">jupyterlite loves webassembly</a></li>
<li><a href="https://github.com/PyDataOsaka/jupyterblog-translation/blob/main/posts/2022-07-14-mamba_meets_jupyterlite.md">mamba meets jupyterlite</a></li>
</ul>
<p>また、翻訳が間に合っておりませんが、下記2つの記事についても触れる予定です。</p>
<ul>
<li>
<a href="https://blog.jupyter.org/jupyter-everywhere-f8151c2cc6e8">Jupyter Everywhere</a><ul>
<li>ウェブページにコンソールやnotebookを埋め込む方法について書かれています</li>
</ul>
</li>
<li>
<a href="https://blog.jupyter.org/xeus-lite-379e96bb199d">Xeus lite</a><ul>
<li>カーネルを作成するためのC++ライブラリであるXeusをJupyterliteで使うための話が載っています。</li>
</ul>
</li>
</ul>
<p>上記についても将来的に翻訳したいと考えているため、回を分けて紹介するかもしれません。</p>
<h3>nikolaブログの記事をコンテンツとして追加した状態でjupyterlite静的サイトを作る方法(後半)</h3>
<p>本ブログはmarkdownとipynbで書かれていますが、これらの記事を追加した状態でjupyterliteの静的サイトをGitHub actionsで生成し、公開する例を紹介します。</p>
<h4>仕組みの概要</h4>
<ul>
<li>
<a href="https://github.com/wrist/wrist.github.io/tree/src">ブログのsrcブランチ</a>の内容を元に静的ブログをビルド(static site generatorのnikolaを使用)</li>
<li>
<a href="https://github.com/wrist/wrist.github.io/blob/src/.github/workflows/build.yml">このワークフロー</a>でブログ構築およびjupyterlite生成を自動化<ul>
<li>
<a href="https://github.com/wrist/docker-jupyterlab-custom">このリポジトリに従って作成されたDockerイメージ</a>を用いてワークフローを実行</li>
<li>jupyterliteを静的アセットとして動的に生成した上で、nikolaブログのビルドを行い、デプロイを実行</li>
<li>jupyterliteの生成のためには<a href="https://github.com/wrist/wrist.github.io/blob/src/generate_jupyterlite.sh">このスクリプト</a>を実行<ul>
<li>
<code>jupyter lite</code>コマンドのオプションは<a href="https://jupyterlite.readthedocs.io/en/latest/reference/cli.html">ここ</a>を参照</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>jupyterlab-wav</h4>
<p><a href="https://github.com/wrist/jupyterlab-wav">このリポジトリ</a>で公開しているjupyterlab向けの波形可視化エクステンションがありますが、
dockerでの実行環境内に存在している場合(actionsのworkflow内でpip installしている場合)は、federated extensionとして使用可能な状態になっているはずですので紹介します。</p>
<h4>GitHub Actions設定時に遭遇したトラブルと対策</h4>
<h5>
<code>actions/checkout@v3</code>で<code>EACCESS: permission denied</code>などとエラーが出てチェックアウトできない</h5>
<p><a href="https://github.com/actions/checkout/issues/841">ここ</a>を見て解決しましたが、コンテナ内でチェックアウトする場合は所有権の問題でチェックアウトできないようで、下記のように<code>options: --user root</code>を付けてroot実行が必要でした。</p>
<div class="code"><pre class="code literal-block"><span class="nt">container</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;image&gt;</span><span class="w"></span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">options</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--user root</span><span class="w"></span>
</pre></div>

<h5>
<code>fatal: unsafe repository</code>が出る</h5>
<p><a href="https://zenn.dev/kouta/scraps/726bfce243f72b">ここ</a>を参考に、<code>git config --global --add safe.directory</code>を実行するようにした。</p>
<h5>
<code>fatal: refusing to merge unrelated histories</code>と表示され落ちる</h5>
<p>masterブランチがfetchされておらずローカルとリモートが連続していないことが原因でした。
<code>git fetch origin master --depth 1</code>を追加することで解決しました。</p>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/25/" class="u-url">jupyterlab-wav extensionをjupyterlab 3.xへ対応させた上でWaveSurfer.jsで波形・スペクトログラムが描画できるようにした</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        Hiromasa OHASHI
                    </span></p>
            <p class="dateline">
            <a href="posts/25/" rel="bookmark">
            <time class="published dt-published" datetime="2021-06-18T00:00:00+09:00" itemprop="datePublished" title="2021-06-18 00:00">2021-06-18 00:00</time></a>
            </p>
                        <p class="commentline">
    
    <a href="posts/25/#disqus_thread" data-disqus-identifier="cache/posts/25.html">コメント</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <p>この記事では以前に<a href="https://www.hiromasa.info/posts/20/">このポスト</a>で作成した<code>jupyterlab-wav</code>のExtensionを
<a href="https://wavesurfer-js.org/">WaveSurfer.js</a>を用いて波形+スペクトログラムが描画できるように今年の2月ごろに改良したのでその過程について説明します。
(この文章自体3月に書いたまま放置していたため内容として古くなっている部分があるかもしれません)。</p>
<h3>jupyterlab 3.x系への対応</h3>
<p><a href="https://blog.jupyter.org/jupyterlab-3-0-is-out-4f58385e25bb">Jupyter blog</a>でも紹介されているようにJupyterlab 3.0が2021年の年始にリリースされました。
jupyterlab 3.x系では<a href="https://www.hiromasa.info/posts/21/">このポスト</a>でも触れたDebuggerが導入されたなどの話もありますが、
extension開発者にとって大きな変更点として<code>JupyterLab extensions can now be distributed as prebuilt extensions, which do not require a user to rebuild JupyterLab or have Node.js installed.</code>
とあるように、prebuilt extensionをPyPIなどに登録することによってpipやcondaでextensionをインストールできるようになったことが挙げられます。
これにより、npmやjupyterによるローカルでのビルドなどが不要となったためユーザーはより気軽にExtensionを導入できるようになりました (後述のように従来通りnpmjsからインストールすることも可能です)。</p>
<p>そんな訳で<code>jupyterlab-wav</code>もpipでインストールできるようになりました。</p>
<div class="code"><pre class="code literal-block">$ pip install jupyterlab-wav
</pre></div>

<p>で簡単に導入できます。</p>
<h3>
<a href="https://wavesurfer-js.org/">WaveSurfer.js</a>の導入</h3>
<p>以前のポストで作成した<code>jupyterlab-wav</code>はMIME Rendererのテンプレートをそのまま使っただけのものでしたが、
今回の更新にあたり<a href="https://wavesurfer-js.org/">WaveSurfer.js</a>を用いて波形・スペクトログラムが描画できるようになりました。
また、wavファイルだけでなくmp3ファイルとflacファイルも再生できるようになりました。</p>
<p><img alt="screenshot" src="images/25/screenshot_v020.png"></p>
<p>マルチチャンネルファイルのスペクトログラムが描画できないなど、まだまだ不具合などは残っていますが最低限使えるような状態にはなっています。</p>
<h3>jupyterlab extensionの2.x系から3.x系への更新作業</h3>
<p>2.x系から3.x系へとextensionを更新する際には
<a href="https://jupyterlab.readthedocs.io/en/latest/extension/extension_migration.html">Extension Migration Guide</a>を見ながら作業を行いました。</p>
<h4>手動で<code>package.json</code>のバージョンを上げる場合</h4>
<p>下記の<code>@jupyterlab/application</code>のバージョンを^3.0.0へと変更すれば良いとのこと。</p>
<div class="code"><pre class="code literal-block"><span class="w">  </span><span class="nt">"dependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="nt">"@jupyterlab/application"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^3.0.0"</span><span class="p">,</span><span class="w"></span>
</pre></div>

<p>しかしjupyterlab 3.0には前述のようにextensionを<code>PyPI</code>や<code>conda-forge</code>にアップロードすることで<code>pip</code>や<code>conda</code>でextensionがインストールできるようになり、
そのためのパッケージングの仕組みが提供されているため、下記手順に沿って対応した方が良いと思われます。</p>
<h4>upgradeスクリプトを用いた更新</h4>
<p>Jupyterlab 3.0はupgrade用のスクリプトを公開しているのでこれを用いてバージョンを上げたいと思います。
まずpipで<code>jupyter-packaging</code>と<code>cookiecutter</code>をインストールします。</p>
<div class="code"><pre class="code literal-block">$ pip install jupyterlab -U
$ pip install jupyter-packaging cookiecutter
</pre></div>

<p>上記を実行した上でextensionのルートディレクトリで下記コマンドを実行すると対話的に各種項目を設定することができます。
<code>python_name [wrist_jupyterlab_wav]:</code>の部分はpythonパッケージ名となり、ここではデフォルトのまま実行していましたが、最終的には各種設定を手動で<code>jupyterlab_wav</code>に書き直しています。</p>
<div class="code"><pre class="code literal-block">$ python -m jupyterlab.upgrade_extension .
author_name <span class="o">[</span>wrist &lt;stoicheia1986@gmail.com&gt;<span class="o">]</span>:
python_name <span class="o">[</span>wrist_jupyterlab_wav<span class="o">]</span>:
labextension_name <span class="o">[</span>@wrist/jupyterlab-wav<span class="o">]</span>:
project_short_description <span class="o">[</span>A JupyterLab extension <span class="k">for</span> rendering wav files.<span class="o">]</span>:
has_server_extension <span class="o">[</span>n<span class="o">]</span>:
has_binder <span class="o">[</span>n<span class="o">]</span>:
repository <span class="o">[</span>https://github.com/wrist/jupyterlab-wav<span class="o">]</span>:
overwrite scripts <span class="k">in</span> package.json? <span class="o">[</span>n<span class="o">]</span>:
overwrite <span class="s2">".gitignore"</span>? <span class="o">[</span>n<span class="o">]</span>:
overwrite <span class="s2">"README.md"</span>? <span class="o">[</span>n<span class="o">]</span>:
overwrite <span class="s2">"tsconfig.json"</span>? <span class="o">[</span>n<span class="o">]</span>:
overwrite <span class="s2">"src/index.ts"</span>? <span class="o">[</span>n<span class="o">]</span>:
overwrite <span class="s2">"style/index.css"</span>? <span class="o">[</span>n<span class="o">]</span>:
** package.json scripts must be updated manually
** skipped _temp_extension/.gitignore
** skipped _temp_extension/README.md
** skipped _temp_extension/tsconfig.json
** skipped _temp_extension/src/index.ts
** skipped _temp_extension/style/index.css
** Remove _temp_extensions directory when finished
<span class="o">(</span>
</pre></div>

<p>上記を実行すると、<code>package.json</code>が下記のように上書きされます。</p>
<div class="code"><pre class="code literal-block"><span class="w">(base) jovyan@188a4999b58c:/mnt/work/python/tmp/jupyterlab-wav$ git diff</span>
<span class="gh">diff --git a/package.json b/package.json</span><span class="w"></span>
<span class="gh">index 0feeaed..cf1620b 100644</span><span class="w"></span>
<span class="gd">--- a/package.json</span><span class="w"></span>
<span class="gi">+++ b/package.json</span><span class="w"></span>
<span class="gu">@@ -4,8 +4,11 @@</span><span class="w"></span>
<span class="w"> </span>  "description": "A JupyterLab extension for rendering wav files.",<span class="w"></span>
<span class="w"> </span>  "author": "wrist &lt;stoicheia1986@gmail.com&gt;",<span class="w"></span>
<span class="w"> </span>  "homepage": "https://github.com/wrist/jupyterlab-wav",<span class="w"></span>
<span class="gd">-  "repository": {"type": "git", "url": "https://github.com/wrist/jupyterlab-wav"},</span><span class="w"></span>
<span class="gd">-  "license" : "MIT",</span><span class="w"></span>
<span class="gi">+  "repository": {</span><span class="w"></span>
<span class="gi">+    "type": "git",</span><span class="w"></span>
<span class="gi">+    "url": "https://github.com/wrist/jupyterlab-wav"</span><span class="w"></span>
<span class="gi">+  },</span><span class="w"></span>
<span class="gi">+  "license": "MIT",</span><span class="w"></span>
<span class="w"> </span>  "main": "lib/index.js",<span class="w"></span>
<span class="w"> </span>  "types": "lib/index.d.ts",<span class="w"></span>
<span class="w"> </span>  "style": "style/index.css",<span class="w"></span>
<span class="gu">@@ -16,27 +19,38 @@</span><span class="w"></span>
<span class="w"> </span>  ],<span class="w"></span>
<span class="w"> </span>  "files": [<span class="w"></span>
<span class="w"> </span>    "lib/**/*.{d.ts,eot,gif,html,jpg,js,js.map,json,png,svg,woff2,ttf}",<span class="w"></span>
<span class="gd">-    "style/**/*.{css,eot,gif,html,jpg,json,png,svg,woff2,ttf}"</span><span class="w"></span>
<span class="gi">+    "style/**/*.{css,eot,gif,html,jpg,json,png,svg,woff2,ttf}",</span><span class="w"></span>
<span class="gi">+    "style/index.js"</span><span class="w"></span>
<span class="w"> </span>  ],<span class="w"></span>
<span class="w"> </span>  "jupyterlab": {<span class="w"></span>
<span class="gd">-    "mimeExtension": true</span><span class="w"></span>
<span class="gi">+    "mimeExtension": true,</span><span class="w"></span>
<span class="gi">+    "outputDir": "wrist_jupyterlab_wav/labextension"</span><span class="w"></span>
<span class="w"> </span>  },<span class="w"></span>
<span class="w"> </span>  "scripts": {<span class="w"></span>
<span class="gd">-    "clean": "rimraf lib &amp;&amp; rimraf tsconfig.tsbuildinfo",</span><span class="w"></span>
<span class="w"> </span>    "build": "tsc",<span class="w"></span>
<span class="gd">-    "prepare": "npm run clean &amp;&amp; npm run build",</span><span class="w"></span>
<span class="gd">-    "watch": "tsc -w",</span><span class="w"></span>
<span class="gi">+    "clean": "rimraf lib &amp;&amp; rimraf tsconfig.tsbuildinfo",</span><span class="w"></span>
<span class="gi">+    "extension:disable": "jupyter labextension disable jupyterlab-wav",</span><span class="w"></span>
<span class="gi">+    "extension:enable": "jupyter labextension enable jupyterlab-wav",</span><span class="w"></span>
<span class="w"> </span>    "extension:install": "jupyter labextension install jupyterlab-wav",<span class="w"></span>
<span class="w"> </span>    "extension:uninstall": "jupyter labextension uninstall  jupyterlab-wav",<span class="w"></span>
<span class="gd">-    "extension:enable": "jupyter labextension enable jupyterlab-wav",</span><span class="w"></span>
<span class="gd">-    "extension:disable": "jupyter labextension disable jupyterlab-wav"</span><span class="w"></span>
<span class="gi">+    "prepare": "npm run clean &amp;&amp; npm run build",</span><span class="w"></span>
<span class="gi">+    "watch": "tsc -w"</span><span class="w"></span>
<span class="w"> </span>  },<span class="w"></span>
<span class="w"> </span>  "dependencies": {<span class="w"></span>
<span class="gd">-    "@jupyterlab/rendermime-interfaces": "^2.0.0",</span><span class="w"></span>
<span class="gd">-    "@lumino/widgets": "^1.5.0"</span><span class="w"></span>
<span class="gi">+    "@jupyterlab/rendermime-interfaces": "^3.0.2",</span><span class="w"></span>
<span class="gi">+    "@lumino/widgets": "^1.16.1"</span><span class="w"></span>
<span class="w"> </span>  },<span class="w"></span>
<span class="w"> </span>  "devDependencies": {<span class="w"></span>
<span class="gd">-    "rimraf": "^2.6.3",</span><span class="w"></span>
<span class="gd">-    "typescript": "~3.7.0"</span><span class="w"></span>
<span class="gd">-  }</span><span class="w"></span>
<span class="gd">-}</span><span class="w"></span>
<span class="gi">+    "@jupyterlab/builder": "^3.0.0",</span><span class="w"></span>
<span class="gi">+    "@typescript-eslint/eslint-plugin": "^4.8.1",</span><span class="w"></span>
<span class="gi">+    "@typescript-eslint/parser": "^4.8.1",</span><span class="w"></span>
<span class="gi">+    "eslint": "^7.14.0",</span><span class="w"></span>
<span class="gi">+    "eslint-config-prettier": "^6.15.0",</span><span class="w"></span>
<span class="gi">+    "eslint-plugin-prettier": "^3.1.4",</span><span class="w"></span>
<span class="gi">+    "npm-run-all": "^4.1.5",</span><span class="w"></span>
<span class="gi">+    "prettier": "^2.1.1",</span><span class="w"></span>
<span class="gi">+    "rimraf": "^3.0.2",</span><span class="w"></span>
<span class="gi">+    "typescript": "~4.1.3"</span><span class="w"></span>
<span class="gi">+  },</span><span class="w"></span>
<span class="gi">+  "styleModule": "style/index.js"</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
</pre></div>

<p>各種依存ライブラリのバージョンが更新されていることが分かります。
<code>@jupyterlab/builder</code>が<code>devDependency</code>に追加されているが、これは<code>federated extension</code>としてextensionをビルドするために必要となるものです。
これはwebpackのような依存を内部に隠蔽し、pythonパッケージの一部として配布可能なassetを生成するものとのことです。
extension開発においては直接<code>@jupyterlab/builder</code>を対話的に操作することはないが、その代わりに<code>jupyter labextension build</code>コマンドを用いることができます。
このコマンドはビルドスクリプト<code>jlpm run build</code>の一部として自動的に実行されます。</p>
<p>また、<code>python -m jupyterlab.upgrade_extension .</code>の実行によりパッケージングに必要となる<code>setup.py</code>や<code>pyproject.toml</code>などが生成されています。
実際に実行したところ、下記のファイル/ディレクトリ群が追加されていました。</p>
<div class="code"><pre class="code literal-block">.eslintignore
.eslintrc.js
.github/
.prettierignore
.prettierrc
LICENSE
MANIFEST.in
_temp_extension/
install.json
pyproject.toml
setup.py
style/base.css
style/index.js
wrist_jupyterlab_wav/
</pre></div>

<p><code>eslint</code>は構文チェック、<code>prettier</code>はフォーマッタであり、それらの設定ファイルが追加されています。
<code>LICENSE</code>は自動的に追加されていたが中身は3条項BSDライセンスでした。元々存在していたpackage.jsonにはLicenseをMITと記載していましたが、これを受けてBSD3-clauseに修正しています。</p>
<p><code>.github</code>以下にはgithub actionsで使用するworkflow定義のymlファイルが格納されています。<code>main</code>ブランチに対して動作するため、今回はmasterに対して発動するように修正しています。</p>
<p>また、実際にgithubにpushしてactionsのタブを見るとbuild時にエラーが出ていました、これは<code>package.json</code>の<code>scripts</code>に<code>eslint:check</code>が存在していないためでした。
ここでは下記のscirptsを追加した上で、実際にeslintを実行して指摘箇所の修正を行いました。</p>
<div class="code"><pre class="code literal-block"><span class="w">   </span><span class="nt">"eslint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eslint . --ext .ts,.tsx --fix"</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="nt">"eslint:check"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eslint . --ext .ts,.tsx"</span><span class="p">,</span><span class="w"></span>
</pre></div>

<p>ここに限らずmigrateの過程でpackage.jsonにscriptが全て追加されておらず、<code>build:prod</code>のscriptがないために生じたエラーなどにも遭遇しましたが、
最終的には<code>https://github.com/jupyterlab/extension-cookiecutter-ts</code>のリポジトリのpackage.jsonに記載のscriptを追加することで解決しています。</p>
<h4>extensionのローカルインストール</h4>
<p><a href="https://www.hiromasa.info/posts/20/">過去に書いた記事</a>では下記のようにビルドを実行していましたが、</p>
<div class="code"><pre class="code literal-block">$ jlpm install
$ jlpm run build
$ jupyter labextension install . --no-build
$ jupyter lab
</pre></div>

<p>テンプレートディレクトリのREADME.mdに記載されている下記手順のように実行することでローカルでのテスト用にextensionをjupyterlabにリンクできます。</p>
<div class="code"><pre class="code literal-block">$ pip install -e .
$ jupyter labextension develop . --overwrite
$ jlpm run build
</pre></div>

<p>jlpmによるビルドが終了した後にjupyterlabを立ち上げるとextensionが有効化されているはずです。</p>
<h3>jupyterlab-wavの修正</h3>
<p>今回の作業のついでに<code>jupyterlab-wav</code>を改良しています。
前述のように波形可視化ライブラリである<code>wavesurfer.js</code>を追加し、これを用いて描画を試みていますが、
下記のように最初にjlpmでパッケージをいくつか追加しています。</p>
<div class="code"><pre class="code literal-block">$ jlpm add wavesurfer.js
$ jlpm add @types/wavesurfer.js
$ jlpm add colormap
</pre></div>

<h3>react-widgetの導入</h3>
<p>以前のMIME Extensionのテンプレートを改造しただけのプロジェクトでは<code>IRenderMime.IRenderer</code>を実装するためのクラスを作り、
ファイルをjupyterlabで開いた際に呼ばれる<code>renderModel</code>メソッドを定義して<code>audio</code>要素に<code>src</code>属性を設定していただけでしたが、
今回の修正では<code>react-widget</code>を下記コードのように導入しています。</p>
<div class="code"><pre class="code literal-block"><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ReactWidget</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@jupyterlab/apputils'</span><span class="p">;</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">IRenderMime</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'@jupyterlab/rendermime-interfaces'</span><span class="p">;</span><span class="w"></span>

<span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'react'</span><span class="p">;</span><span class="w"></span>
<span class="k">import</span><span class="w"> </span><span class="nx">AudioComponent</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">'./AudioComponent'</span><span class="p">;</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">CLASS_NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'mimerenderer-wav'</span><span class="p">;</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * A widget for rendering wav.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">WavWidget</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">ReactWidget</span><span class="w"> </span><span class="k">implements</span><span class="w"> </span><span class="nx">IRenderMime</span><span class="p">.</span><span class="nx">IRenderer</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="kt">IRenderMime.IRendererOptions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">super</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">_mimeType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">mimeType</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">_src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">CLASS_NAME</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">renderModel</span><span class="p">(</span><span class="nx">model</span><span class="o">:</span><span class="w"> </span><span class="kt">IRenderMime.IMimeModel</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_mimeType</span><span class="p">]</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">_src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`data:</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">_mimeType</span><span class="si">}</span><span class="sb">;base64,</span><span class="si">${</span><span class="nx">data</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nx">render</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&lt;</span><span class="nx">AudioComponent</span><span class="w"> </span><span class="nx">src</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">_src</span><span class="p">}</span><span class="w"> </span><span class="o">/&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">_src</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">_mimeType</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

<p>jupyterlab上でファイルを開いた際に<code>renderModel</code>メソッドが呼ばれる点は同じですが、
この際に<code>this.update()</code>を実行することで<code>ReactWidget</code>をextendsする際に必須となる<code>render</code>メソッドを明示的に呼び出しています。
<code>render</code>メソッドは<code>&lt;AudioComponent ...&gt;</code>のJSXタグを返しますが、この<code>AudioComponent</code>は<code>AudioComponent.tsx</code>内で定義されたReactコンポーネントとなります。
Reactコンポーネント自体はjupyterlabと独立にReact単体のエコシステム上で別途動作検証やデバッグができるため、
<code>ReactWidget</code>の導入によりextension開発が容易になりました。</p>
<h3>extensionの公開方法</h3>
<p>パッケージングの方法については<a href="https://jupyterlab.readthedocs.io/en/latest/extension/extension_tutorial.html#packaging-your-extension">extension tutorialのpackagingの部分</a>に、
アップロードの方法については<a href="https://jupyterlab.readthedocs.io/en/latest/extension/extension_tutorial.html#extension-tutorial-publish">extension tutorialのpublishに関する部分</a>に説明があります。</p>
<h4>PyPIへのアップロード</h4>
<p>自動生成された<code>setup.py</code>を用いてパッケージのビルドを行います。</p>
<div class="code"><pre class="code literal-block">$ python setup.py build sdist
$ python setup.py build bdist_wheel
</pre></div>

<p>ビルドの成果物がdist以下に保存されるので、これらをPyPIへとアップロードします。
ここではtwineを使ってアップロードを行います。
予めTestPyPIにアップロードし問題ないことを確認した上でPyPIへとアップロードします。</p>
<div class="code"><pre class="code literal-block">$ pip install twine
$ twine upload --repository-url https://test.pypi.org/legacy/ dist/*
$ twine upload dist/*
</pre></div>

<h4>npmjsへのアップロード</h4>
<p>extensionはPyPIやconda-forgeにアップロードするだけでなく、従来のようにnpmへとアップロードすることもできます。
これはnpmパッケージとして配布することでユーザーがJupyterLab 1.xや2.xと同様にextensionを明示的にコンパイルして追加することが可能となるためであったり、
他のextensionからサービスとして利用されるextensionを公開したい場合はJavaScriptパッケージをpublishする必要があるためとのことです。</p>
<p>以前の記事では<code>npm</code>を使ってアップロードしていましたが、ここではjlpmを使ってアップロードを試みました。</p>
<div class="code"><pre class="code literal-block">$ jlpm publish --access<span class="o">=</span>public
</pre></div>

<h4>作成中に遭遇した問題</h4>
<ul>
<li>複数の音源ファイルを開いた場合に一つのタブに描画されてしまう<ul>
<li>描画対象のdivをidで指定していたためであり、Reactの<code>useRef</code>を用いた参照に切り替えることによって解決</li>
</ul>
</li>
<li>開発用の手順が失敗する<ul>
<li>
<code>jupyter labextension develop . --overwrite</code>に失敗したが、これはPyPIに公開するパッケージディレクトリ(<code>jupyterlab_wav</code>)の下に<code>__init__.py</code>と<code>_version.py</code>がないためでした</li>
<li>
<a href="https://github.com/jupyterlab/extension-cookiecutter-ts/tree/3.0/%7B%7Bcookiecutter.python_name%7D%7D/%7B%7Bcookiecutter.python_name%7D%7D">このテンプレート</a>のファイルを加工して使うことで成功するようになりました</li>
</ul>
</li>
</ul>
<h4>既知の問題</h4>
<ul>
<li>Multi channelのaudioファイルが正しく描画されない<ul>
<li>波形は<code>splitChannels</code>オプションを使うことで分割して描画されるようになりました</li>
<li>スペクトログラムは要対応</li>
</ul>
</li>
<li>タブの再描画などの際に以前に再生した音声が止まらないまま残ってしまう<ul>
<li>再生中にタブを閉じると再生され続ける<ul>
<li>ReactWidgetの解放時に確実に止めるための何かが必要ではないかと思われる</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>今後改良したい点</h4>
<ul>
<li>FFT長選択のUIをつける</li>
<li>Jupyterlabから設定を行えるようにする</li>
<li>キーボードショートカットをつける(スペースで再生など)</li>
<li>timelineの単位の指定(サンプルなど)</li>
<li>colormapの制御</li>
</ul>
</div>
            </article>
</div>
    
        <ul class="pager postindexpager clearfix">
<li class="next"><a href="index-8.html" rel="next">過去の記事</a></li>
        </ul>
<script>var disqus_shortname="hiromasa-info";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><!--End of body content--><footer id="footer">
            Contents © 2022         <a href="mailto:stoicheia1986@gmail.com">Hiromasa OHASHI</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
<!-- twitter -->
<a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><!-- facebook --><div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = 'https://connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.11';
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script><div class="fb-like" data-layout="button" data-action="like" data-size="small" data-show-faces="true" data-share="true"></div>

<!-- hatena -->
<a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-counter" title="このエントリーをはてなブックマークに追加">
<img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;"></a>
<script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script></footer>
</div>
</div>


        <script src="assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
